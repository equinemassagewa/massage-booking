<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Massage Booking</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2.39.3/dist/umd/supabase.js"></script>
</head>
<body class="bg-gray-100">
    <div class="min-h-screen">
        <!-- Header -->
        <div class="bg-white shadow">
            <div class="max-w-7xl mx-auto px-4 py-4">
                <h1 class="text-3xl font-bold text-gray-900">Admin Dashboard</h1>
                <p class="text-gray-600">Equine & Canine Massage WA</p>
            </div>
        </div>

        <!-- Main Content -->
        <div class="max-w-7xl mx-auto px-4 py-8">
            
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="text-sm text-gray-600">This Week</div>
                    <div class="text-3xl font-bold text-blue-600" id="statsThisWeek">-</div>
                    <div class="text-xs text-gray-500">appointments</div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="text-sm text-gray-600">Next 8 Weeks</div>
                    <div class="text-3xl font-bold text-green-600" id="statsNext8Weeks">-</div>
                    <div class="text-xs text-gray-500">appointments</div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="text-sm text-gray-600">Revenue (YTD)</div>
                    <div class="text-3xl font-bold text-purple-600" id="statsRevenue">$-</div>
                    <div class="text-xs text-gray-500">confirmed bookings</div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="text-sm text-gray-600">Active Clients</div>
                    <div class="text-3xl font-bold text-orange-600" id="statsClients">-</div>
                    <div class="text-xs text-gray-500">total clients</div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="bg-white rounded-lg shadow mb-4">
                <div class="flex border-b overflow-x-auto">
                    <button onclick="showTab('schedule')" id="tabSchedule" class="px-6 py-3 font-semibold border-b-2 border-blue-600 text-blue-600 whitespace-nowrap">
                        Schedule
                    </button>
                    <button onclick="showTab('clients')" id="tabClients" class="px-6 py-3 font-semibold text-gray-600 hover:text-gray-900 whitespace-nowrap">
                        Clients
                    </button>
                    <button onclick="showTab('revenue')" id="tabRevenue" class="px-6 py-3 font-semibold text-gray-600 hover:text-gray-900 whitespace-nowrap">
                        Revenue
                    </button>
                </div>
            </div>

            <!-- Schedule Tab -->
            <div id="contentSchedule" class="bg-white rounded-lg shadow p-6">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold">Your Schedule</h2>
                    <div class="flex gap-2">
                        <button onclick="changeWeek(-1)" class="px-3 py-2 bg-gray-200 rounded hover:bg-gray-300 text-sm">‚Üê Prev</button>
                        <button onclick="changeWeek(0)" class="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">This Week</button>
                        <button onclick="changeWeek(1)" class="px-3 py-2 bg-gray-200 rounded hover:bg-gray-300 text-sm">Next ‚Üí</button>
                    </div>
                </div>
                <div id="scheduleView" class="space-y-4">
                    <p class="text-center text-gray-500">Loading schedule...</p>
                </div>
            </div>

            <!-- Clients Tab -->
            <div id="contentClients" class="bg-white rounded-lg shadow p-6 hidden">
                <h2 class="text-2xl font-bold mb-6">All Clients</h2>
                <div id="clientsView">
                    <p class="text-center text-gray-500">Loading clients...</p>
                </div>
            </div>

            <!-- Revenue Tab -->
            <div id="contentRevenue" class="bg-white rounded-lg shadow p-6 hidden">
                <h2 class="text-2xl font-bold mb-6">Revenue Report</h2>
                <div id="revenueView">
                    <p class="text-center text-gray-500">Loading revenue data...</p>
                </div>
            </div>

        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://lnlwsluopuprtqooorgi.supabase.co'
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxubHdzbHVvcHVwcnRxb29vcmdpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3NTkyOTIsImV4cCI6MjA3ODMzNTI5Mn0.k9R1TAjIn74sznur24mocLFKQYLWYILAQL8tM0hs5dg'
        
        const { createClient } = supabase
        const client = createClient(SUPABASE_URL, SUPABASE_KEY)

        let currentWeekOffset = 0
        let allAppointments = []
        let allClients = []

        async function init() {
            await loadData()
            updateStats()
            showSchedule()
        }

        async function loadData() {
            try {
                const { data: appointments } = await client
                    .from('appointments')
                    .select('*, clients(*)')
                    .order('appointment_date', { ascending: true })

                allAppointments = appointments || []

                const { data: clients } = await client
                    .from('clients')
                    .select('*')
                    .eq('is_active', true)
                    .order('client_name', { ascending: true })

                allClients = clients || []

            } catch (error) {
                console.error('Error loading data:', error)
            }
        }

        function updateStats() {
            const now = new Date()
            const startOfWeek = new Date(now)
            startOfWeek.setDate(now.getDate() - now.getDay() + 1)
            const endOfWeek = new Date(startOfWeek)
            endOfWeek.setDate(startOfWeek.getDate() + 6)

            const in8Weeks = new Date(now)
            in8Weeks.setDate(now.getDate() + 56)

            const thisWeek = allAppointments.filter(apt => {
                const date = new Date(apt.appointment_date)
                return date >= startOfWeek && date <= endOfWeek && apt.status === 'confirmed'
            })

            const next8Weeks = allAppointments.filter(apt => {
                const date = new Date(apt.appointment_date)
                return date >= now && date <= in8Weeks && apt.status === 'confirmed'
            })

            const ytdRevenue = allAppointments
                .filter(apt => apt.status === 'confirmed' && new Date(apt.appointment_date).getFullYear() === now.getFullYear())
                .reduce((sum, apt) => sum + parseFloat(apt.total_price || 0), 0)

            document.getElementById('statsThisWeek').textContent = thisWeek.length
            document.getElementById('statsNext8Weeks').textContent = next8Weeks.length
            document.getElementById('statsRevenue').textContent = '$' + ytdRevenue.toFixed(0)
            document.getElementById('statsClients').textContent = allClients.length
        }

        function showTab(tab) {
            document.getElementById('contentSchedule').classList.add('hidden')
            document.getElementById('contentClients').classList.add('hidden')
            document.getElementById('contentRevenue').classList.add('hidden')

            document.getElementById('tabSchedule').className = 'px-6 py-3 font-semibold text-gray-600 hover:text-gray-900 whitespace-nowrap'
            document.getElementById('tabClients').className = 'px-6 py-3 font-semibold text-gray-600 hover:text-gray-900 whitespace-nowrap'
            document.getElementById('tabRevenue').className = 'px-6 py-3 font-semibold text-gray-600 hover:text-gray-900 whitespace-nowrap'

            if (tab === 'schedule') {
                document.getElementById('contentSchedule').classList.remove('hidden')
                document.getElementById('tabSchedule').className = 'px-6 py-3 font-semibold border-b-2 border-blue-600 text-blue-600 whitespace-nowrap'
                showSchedule()
            } else if (tab === 'clients') {
                document.getElementById('contentClients').classList.remove('hidden')
                document.getElementById('tabClients').className = 'px-6 py-3 font-semibold border-b-2 border-blue-600 text-blue-600 whitespace-nowrap'
                showClients()
            } else if (tab === 'revenue') {
                document.getElementById('contentRevenue').classList.remove('hidden')
                document.getElementById('tabRevenue').className = 'px-6 py-3 font-semibold border-b-2 border-blue-600 text-blue-600 whitespace-nowrap'
                showRevenue()
            }
        }

        function changeWeek(offset) {
            if (offset === 0) {
                currentWeekOffset = 0
            } else {
                currentWeekOffset += offset
            }
            showSchedule()
        }

        function showSchedule() {
            const now = new Date()
            const startOfWeek = new Date(now)
            startOfWeek.setDate(now.getDate() - now.getDay() + 1 + (currentWeekOffset * 7))
            const endOfWeek = new Date(startOfWeek)
            endOfWeek.setDate(startOfWeek.getDate() + 6)

            const weekAppointments = allAppointments.filter(apt => {
                const date = new Date(apt.appointment_date)
                return date >= startOfWeek && date <= endOfWeek
            }).sort((a, b) => {
                if (a.appointment_date === b.appointment_date) {
                    return a.appointment_time.localeCompare(b.appointment_time)
                }
                return a.appointment_date.localeCompare(b.appointment_date)
            })

            let html = `<div class="mb-4 text-center text-xl font-semibold">
                Week of ${startOfWeek.toLocaleDateString('en-AU', {month: 'long', day: 'numeric', year: 'numeric'})}
            </div>`

            if (weekAppointments.length === 0) {
                html += '<p class="text-center text-gray-500 py-8">No appointments this week</p>'
            } else {
                let currentDate = null
                weekAppointments.forEach(apt => {
                    if (apt.appointment_date !== currentDate) {
                        if (currentDate !== null) html += '</div>'
                        currentDate = apt.appointment_date
                        const date = new Date(apt.appointment_date)
                        html += `<div class="mb-6">
                            <h3 class="text-lg font-bold mb-3 pb-2 border-b">
                                ${date.toLocaleDateString('en-AU', {weekday: 'long', month: 'long', day: 'numeric'})}
                            </h3>`
                    }

                    const statusColors = {
                        confirmed: 'bg-green-100 border-green-300',
                        pending: 'bg-yellow-100 border-yellow-300',
                        cancelled: 'bg-red-100 border-red-300',
                        completed: 'bg-gray-100 border-gray-300'
                    }

                    html += `
                        <div class="mb-3 p-4 border-2 rounded-lg ${statusColors[apt.status] || 'bg-white border-gray-200'}">
                            <div class="flex flex-col sm:flex-row justify-between gap-4">
                                <div class="flex-1">
                                    <div class="text-xl font-bold">${apt.appointment_time}</div>
                                    <div class="text-lg font-semibold">${apt.clients?.client_name || 'Unknown Client'}</div>
                                    <div class="text-sm text-gray-600">${apt.clients?.address || ''}, ${apt.clients?.postcode || ''}</div>
                                    <div class="text-sm mt-1">
                                        <span class="font-semibold">${apt.service_type === 'equine' ? 'üê¥' : 'üêï'} ${apt.number_of_animals} ${apt.service_type}</span>
                                        ${apt.appointment_type === 'initial' ? ' ‚Ä¢ Initial' : ' ‚Ä¢ Follow-up'}
                                    </div>
                                    ${apt.notes ? `<div class="text-sm text-gray-600 mt-1">üìù ${apt.notes}</div>` : ''}
                                </div>
                                <div class="text-right">
                                    <div class="text-lg font-bold">$${apt.total_price}</div>
                                    <div class="text-xs text-gray-600">${apt.duration_minutes} min</div>
                                    <div class="text-xs px-2 py-1 rounded mt-2 inline-block ${statusColors[apt.status] || ''}">${apt.status.toUpperCase()}</div>
                                </div>
                            </div>
                        </div>
                    `
                })
                if (currentDate !== null) html += '</div>'
            }

            document.getElementById('scheduleView').innerHTML = html
        }

        function showClients() {
            let html = '<div class="space-y-3">'
            allClients.forEach(client => {
                html += `
                    <div class="border rounded-lg p-4 hover:shadow-lg transition-shadow">
                        <div class="flex flex-col sm:flex-row justify-between gap-4">
                            <div class="flex-1">
                                <div class="text-lg font-bold">${client.client_name}</div>
                                <div class="text-sm text-gray-600">${client.address}, ${client.postcode}</div>
                                ${client.phone ? `<div class="text-sm text-gray-600">üì± ${client.phone}</div>` : ''}
                                ${client.email ? `<div class="text-sm text-gray-600">üìß ${client.email}</div>` : ''}
                                ${client.fb_contact ? `<div class="text-sm text-gray-600">üí¨ ${client.fb_contact}</div>` : ''}
                                ${client.notes ? `<div class="text-sm text-gray-500 mt-1">üìù ${client.notes}</div>` : ''}
                            </div>
                            <div class="text-right">
                                ${client.legacy_pricing ? '<div class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded inline-block">Legacy Pricing</div>' : ''}
                            </div>
                        </div>
                    </div>
                `
            })
            html += '</div>'
            document.getElementById('clientsView').innerHTML = html
        }

        function showRevenue() {
            const now = new Date()
            const thisYear = now.getFullYear()
            
            const months = {}
            for (let i = 0; i < 12; i++) {
                months[i] = { month: new Date(thisYear, i, 1).toLocaleDateString('en-AU', {month: 'long'}), revenue: 0, count: 0 }
            }

            allAppointments
                .filter(apt => apt.status === 'confirmed' && new Date(apt.appointment_date).getFullYear() === thisYear)
                .forEach(apt => {
                    const month = new Date(apt.appointment_date).getMonth()
                    months[month].revenue += parseFloat(apt.total_price || 0)
                    months[month].count++
                })

            let html = `
                <div class="mb-6">
                    <h3 class="text-xl font-bold mb-4">${thisYear} Revenue by Month</h3>
                    <div class="space-y-2">
            `

            Object.values(months).forEach(m => {
                if (m.count > 0) {
                    html += `
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
                            <div>
                                <span class="font-semibold">${m.month}</span>
                                <span class="text-sm text-gray-600 ml-2">(${m.count} appointments)</span>
                            </div>
                            <div class="text-lg font-bold text-green-600">$${m.revenue.toFixed(2)}</div>
                        </div>
                    `
                }
            })

            const totalRevenue = Object.values(months).reduce((sum, m) => sum + m.revenue, 0)
            const totalAppts = Object.values(months).reduce((sum, m) => sum + m.count, 0)

            html += `
                    </div>
                </div>
                <div class="bg-blue-50 p-6 rounded-lg">
                    <h3 class="text-xl font-bold mb-2">Year-to-Date Totals</h3>
                    <div class="text-3xl font-bold text-blue-600">$${totalRevenue.toFixed(2)}</div>
                    <div class="text-gray-600">${totalAppts} confirmed appointments</div>
                    <div class="text-gray-600 mt-2">Average: $${(totalRevenue / totalAppts).toFixed(2)} per appointment</div>
                </div>
            `

            document.getElementById('revenueView').innerHTML = html
        }

        init()
    </script>
</body>
</html>
