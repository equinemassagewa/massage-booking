<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Massage Booking</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2.39.3/dist/umd/supabase.js"></script>
</head>
<body class="bg-gray-100">
    <div class="min-h-screen">
        <!-- Header -->
        <div class="bg-white shadow">
            <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">Admin Dashboard</h1>
                    <p class="text-gray-600">Equine & Canine Massage WA</p>
                </div>
                <div class="flex gap-2 flex-wrap">
                    <button onclick="showAddClientModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-semibold">
                        + New Client
                    </button>
                    <button onclick="showAddAppointmentModal()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm font-semibold">
                        + New Appointment
                    </button>
                    <button onclick="showAddBlockModal()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm font-semibold">
                        + Block Time
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="max-w-7xl mx-auto px-4 py-8">
            
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="text-sm text-gray-600">This Week</div>
                    <div class="text-3xl font-bold text-blue-600" id="statsThisWeek">-</div>
                    <div class="text-xs text-gray-500">appointments</div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="text-sm text-gray-600">Next 8 Weeks</div>
                    <div class="text-3xl font-bold text-green-600" id="statsNext8Weeks">-</div>
                    <div class="text-xs text-gray-500">appointments</div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="text-sm text-gray-600">Revenue (YTD)</div>
                    <div class="text-3xl font-bold text-purple-600" id="statsRevenue">$-</div>
                    <div class="text-xs text-gray-500">confirmed bookings</div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="text-sm text-gray-600">Active Clients</div>
                    <div class="text-3xl font-bold text-orange-600" id="statsClients">-</div>
                    <div class="text-xs text-gray-500">total clients</div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="bg-white rounded-lg shadow mb-4">
                <div class="flex border-b overflow-x-auto">
                    <button onclick="showTab('schedule')" id="tabSchedule" class="px-6 py-3 font-semibold border-b-2 border-blue-600 text-blue-600 whitespace-nowrap">
                        Schedule
                    </button>
                    <button onclick="showTab('optimizer')" id="tabOptimizer" class="px-6 py-3 font-semibold text-gray-600 hover:text-gray-900 whitespace-nowrap">
                        üöó Route Optimizer
                    </button>
                    <button onclick="showTab('pending')" id="tabPending" class="px-6 py-3 font-semibold text-gray-600 hover:text-gray-900 whitespace-nowrap">
                        Pending Requests <span id="pendingBadge" class="bg-red-500 text-white text-xs rounded-full px-2 py-1 ml-1">0</span>
                    </button>
                    <button onclick="showTab('blocked')" id="tabBlocked" class="px-6 py-3 font-semibold text-gray-600 hover:text-gray-900 whitespace-nowrap">
                        Blocked Times
                    </button>
                    <button onclick="showTab('clients')" id="tabClients" class="px-6 py-3 font-semibold text-gray-600 hover:text-gray-900 whitespace-nowrap">
                        Clients
                    </button>
                    <button onclick="showTab('revenue')" id="tabRevenue" class="px-6 py-3 font-semibold text-gray-600 hover:text-gray-900 whitespace-nowrap">
                        Revenue
                    </button>
                </div>
            </div>

            <!-- Schedule Tab -->
            <div id="contentSchedule" class="bg-white rounded-lg shadow p-6">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold">Your Schedule</h2>
                    <div class="flex gap-2">
                        <button onclick="changeWeek(-1)" class="px-3 py-2 bg-gray-200 rounded hover:bg-gray-300 text-sm">‚Üê Prev</button>
                        <button onclick="changeWeek(0)" class="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">This Week</button>
                        <button onclick="changeWeek(1)" class="px-3 py-2 bg-gray-200 rounded hover:bg-gray-300 text-sm">Next ‚Üí</button>
                    </div>
                </div>
                <div id="scheduleView" class="space-y-4">
                    <p class="text-center text-gray-500">Loading schedule...</p>
                </div>
            </div>

            <!-- Route Optimizer Tab -->
            <div id="contentOptimizer" class="bg-white rounded-lg shadow p-6 hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">üöó Route Optimizer</h2>
                    <div class="flex gap-2">
                        <button onclick="optimizerChangeWeek(-1)" class="px-3 py-2 bg-gray-200 rounded hover:bg-gray-300 text-sm">‚Üê Prev</button>
                        <button onclick="optimizerChangeWeek(0)" class="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">This Week</button>
                        <button onclick="optimizerChangeWeek(1)" class="px-3 py-2 bg-gray-200 rounded hover:bg-gray-300 text-sm">Next ‚Üí</button>
                    </div>
                </div>
                <div id="optimizerView">
                    <p class="text-center text-gray-500">Loading route analysis...</p>
                </div>
            </div>

            <!-- Pending Requests Tab -->
            <div id="contentPending" class="bg-white rounded-lg shadow p-6 hidden">
                <h2 class="text-2xl font-bold mb-6">Pending Booking Requests</h2>
                <div id="pendingView">
                    <p class="text-center text-gray-500">Loading...</p>
                </div>
            </div>

            <!-- Blocked Times Tab -->
            <div id="contentBlocked" class="bg-white rounded-lg shadow p-6 hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Blocked Times</h2>
                    <button onclick="showAddBlockModal()" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 text-sm">
                        + Add Block
                    </button>
                </div>
                <div id="blockedView">
                    <p class="text-center text-gray-500">Loading blocked periods...</p>
                </div>
            </div>

            <!-- Clients Tab -->
            <div id="contentClients" class="bg-white rounded-lg shadow p-6 hidden">
                <h2 class="text-2xl font-bold mb-6">All Clients</h2>
                <div id="clientsView">
                    <p class="text-center text-gray-500">Loading clients...</p>
                </div>
            </div>

            <!-- Revenue Tab -->
            <div id="contentRevenue" class="bg-white rounded-lg shadow p-6 hidden">
                <h2 class="text-2xl font-bold mb-6">Revenue Report</h2>
                <div id="revenueView">
                    <p class="text-center text-gray-500">Loading revenue data...</p>
                </div>
            </div>

        </div>
    </div>

    <!-- Add Client Modal -->
    <div id="clientModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold mb-4">Add New Client</h3>
            <form id="clientForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold mb-1">Client Name *</label>
                    <input type="text" id="clientName" required class="w-full px-3 py-2 border rounded">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold mb-1">Address *</label>
                        <input type="text" id="clientAddress" required class="w-full px-3 py-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-1">Postcode *</label>
                        <input type="text" id="clientPostcode" required class="w-full px-3 py-2 border rounded">
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-semibold mb-1">Phone</label>
                        <input type="tel" id="clientPhone" class="w-full px-3 py-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-1">Email</label>
                        <input type="email" id="clientEmail" class="w-full px-3 py-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-1">Facebook</label>
                        <input type="text" id="clientFB" class="w-full px-3 py-2 border rounded">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-1">Property Name</label>
                    <input type="text" id="clientProperty" class="w-full px-3 py-2 border rounded">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-1">Access Instructions</label>
                    <textarea id="clientAccess" rows="2" class="w-full px-3 py-2 border rounded" placeholder="e.g., Gate code, parking instructions"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-1">Notes</label>
                    <textarea id="clientNotes" rows="2" class="w-full px-3 py-2 border rounded"></textarea>
                </div>
                <div class="flex items-center gap-2">
                    <input type="checkbox" id="clientLegacy" class="w-4 h-4">
                    <label for="clientLegacy" class="text-sm">Legacy Pricing (existing client through Dec 2025)</label>
                </div>
                <div class="flex gap-2 pt-4">
                    <button type="submit" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 font-semibold">
                        Save Client
                    </button>
                    <button type="button" onclick="closeModal('clientModal')" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Appointment Modal -->
    <div id="appointmentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold mb-4">Add New Appointment</h3>
            <form id="appointmentForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold mb-1">Client *</label>
                    <select id="aptClient" required class="w-full px-3 py-2 border rounded">
                        <option value="">Select client...</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold mb-1">Date *</label>
                        <input type="date" id="aptDate" required class="w-full px-3 py-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-1">Time *</label>
                        <input type="time" id="aptTime" required class="w-full px-3 py-2 border rounded">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold mb-1">Service Type *</label>
                        <select id="aptService" required class="w-full px-3 py-2 border rounded">
                            <option value="equine">Equine (Horse)</option>
                            <option value="canine">Canine (Dog)</option>
                            <option value="both">Both (Horse + Dog)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-1">Appointment Type *</label>
                        <select id="aptType" required class="w-full px-3 py-2 border rounded">
                            <option value="initial">Initial</option>
                            <option value="follow-up">Follow-up</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-semibold mb-1">Number of Animals *</label>
                        <input type="number" id="aptNumAnimals" value="1" min="1" required class="w-full px-3 py-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-1">Duration (min) *</label>
                        <input type="number" id="aptDuration" value="60" required class="w-full px-3 py-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-1">Status *</label>
                        <select id="aptStatus" required class="w-full px-3 py-2 border rounded">
                            <option value="confirmed">Confirmed</option>
                            <option value="pending">Pending</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-semibold mb-1">Treatment Price *</label>
                        <input type="number" id="aptPrice" value="100" step="0.01" required class="w-full px-3 py-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-1">Travel Fee *</label>
                        <input type="number" id="aptTravel" value="15" step="0.01" required class="w-full px-3 py-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-1">Total</label>
                        <input type="number" id="aptTotal" readonly class="w-full px-3 py-2 border rounded bg-gray-100">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-1">Notes</label>
                    <textarea id="aptNotes" rows="2" class="w-full px-3 py-2 border rounded"></textarea>
                </div>
                <div class="flex gap-2 pt-4">
                    <button type="submit" class="flex-1 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 font-semibold">
                        Save Appointment
                    </button>
                    <button type="button" onclick="closeModal('appointmentModal')" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Block Modal -->
    <div id="blockModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg p-6 max-w-lg w-full">
            <h3 class="text-2xl font-bold mb-4">Block Time Period</h3>
            <form id="blockForm" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold mb-1">Start Date *</label>
                        <input type="date" id="blockStartDate" required class="w-full px-3 py-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-1">End Date *</label>
                        <input type="date" id="blockEndDate" required class="w-full px-3 py-2 border rounded">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold mb-1">Start Time (optional)</label>
                        <input type="time" id="blockStartTime" class="w-full px-3 py-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-1">End Time (optional)</label>
                        <input type="time" id="blockEndTime" class="w-full px-3 py-2 border rounded">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-1">Reason *</label>
                    <input type="text" id="blockReason" placeholder="e.g., Holiday, Personal" required class="w-full px-3 py-2 border rounded">
                </div>
                <div class="flex gap-2 pt-4">
                    <button type="submit" class="flex-1 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 font-semibold">
                        Save Block
                    </button>
                    <button type="button" onclick="closeModal('blockModal')" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://lnlwsluopuprtqooorgi.supabase.co'
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxubHdzbHVvcHVwcnRxb29vcmdpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3NTkyOTIsImV4cCI6MjA3ODMzNTI5Mn0.k9R1TAjIn74sznur24mocLFKQYLWYILAQL8tM0hs5dg'
        
        const { createClient } = supabase
        const client = createClient(SUPABASE_URL, SUPABASE_KEY)

        // ========== ROUTE OPTIMIZER ENGINE ==========
        class RouteOptimizer {
            constructor() {
                this.homeBase = { postcode: '6082', lat: -31.9505, lng: 116.0361 }
                this.locations = {
                    '6082': { lat: -31.9505, lng: 116.0361, name: 'Mount Helena' },
                    '6081': { lat: -31.9167, lng: 116.1167, name: 'Parkerville' },
                    '6083': { lat: -31.7667, lng: 116.1833, name: 'Gidgegannup' },
                    '6100': { lat: -31.9667, lng: 115.9000, name: 'Lathlain' },
                    '6055': { lat: -31.8500, lng: 115.9667, name: 'Swan Valley' },
                    '6077': { lat: -31.7667, lng: 115.9833, name: 'Gnangara' },
                    '6084': { lat: -31.7000, lng: 116.1333, name: 'Bullsbrook' },
                    '6556': { lat: -31.5500, lng: 116.0500, name: 'Chidlow' },
                    '6171': { lat: -32.3333, lng: 115.8667, name: 'Baldivis' },
                    '6125': { lat: -32.3667, lng: 115.9667, name: 'Serpentine' },
                    '6209': { lat: -32.5333, lng: 115.8833, name: 'Barragup' },
                    '6227': { lat: -33.3333, lng: 115.8167, name: 'Burekup' },
                    '6236': { lat: -33.4000, lng: 115.7500, name: 'Dardanup West' },
                    '6271': { lat: -33.5333, lng: 115.5500, name: 'Capel' },
                    '6285': { lat: -33.9500, lng: 115.0667, name: 'Margaret River' }
                }
            }

            calculateDriveTime(postcode1, postcode2) {
                const loc1 = this.locations[postcode1]
                const loc2 = this.locations[postcode2]
                if (!loc1 || !loc2) return 30
                
                const distance = this.haversineDistance(loc1.lat, loc1.lng, loc2.lat, loc2.lng)
                const roadDistance = distance * 1.3
                let speed = distance > 20 ? 90 : distance > 10 ? 70 : 40
                return Math.ceil((roadDistance / speed) * 60)
            }

            haversineDistance(lat1, lng1, lat2, lng2) {
                const R = 6371
                const dLat = (lat2 - lat1) * Math.PI / 180
                const dLng = (lng2 - lng1) * Math.PI / 180
                const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                          Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                          Math.sin(dLng/2) * Math.sin(dLng/2)
                return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a))
            }

            optimizeSequence(appointments) {
                if (appointments.length === 0) return []
                if (appointments.length === 1) {
                    const driveFromHome = this.calculateDriveTime(this.homeBase.postcode, appointments[0].postcode)
                    const driveToHome = this.calculateDriveTime(appointments[0].postcode, this.homeBase.postcode)
                    return [{
                        ...appointments[0],
                        driveFromHome,
                        driveToHome,
                        sequence: 1
                    }]
                }
                
                const optimized = []
                let currentLocation = this.homeBase.postcode
                let remaining = [...appointments]
                let sequence = 1
                
                // Drive from home to first
                let nearest = null
                let shortestTime = Infinity
                remaining.forEach(apt => {
                    const driveTime = this.calculateDriveTime(currentLocation, apt.postcode)
                    if (driveTime < shortestTime) {
                        shortestTime = driveTime
                        nearest = apt
                    }
                })
                
                if (nearest) {
                    optimized.push({
                        ...nearest,
                        driveFromHome: shortestTime,
                        driveFromPrevious: 0,
                        sequence: sequence++
                    })
                    currentLocation = nearest.postcode
                    remaining = remaining.filter(a => a !== nearest)
                }
                
                // Find nearest neighbor for remaining
                while (remaining.length > 0) {
                    nearest = null
                    shortestTime = Infinity
                    
                    remaining.forEach(apt => {
                        const driveTime = this.calculateDriveTime(currentLocation, apt.postcode)
                        if (driveTime < shortestTime) {
                            shortestTime = driveTime
                            nearest = apt
                        }
                    })
                    
                    if (nearest) {
                        optimized.push({
                            ...nearest,
                            driveFromPrevious: shortestTime,
                            sequence: sequence++
                        })
                        currentLocation = nearest.postcode
                        remaining = remaining.filter(a => a !== nearest)
                    }
                }
                
                // Add drive home from last
                if (optimized.length > 0) {
                    const lastApt = optimized[optimized.length - 1]
                    lastApt.driveToHome = this.calculateDriveTime(lastApt.postcode, this.homeBase.postcode)
                }
                
                return optimized
            }

            calculateMetrics(optimizedRoute) {
                let totalDrive = 0
                let totalTreatment = 0
                
                if (optimizedRoute.length > 0) {
                    totalDrive += optimizedRoute[0].driveFromHome || 0
                    
                    optimizedRoute.forEach((apt, i) => {
                        totalTreatment += apt.duration_minutes || 60
                        if (i > 0) {
                            totalDrive += apt.driveFromPrevious || 0
                        }
                    })
                    
                    totalDrive += optimizedRoute[optimizedRoute.length - 1].driveToHome || 0
                }
                
                const totalTime = totalDrive + totalTreatment
                const efficiency = totalTime > 0 ? (totalTreatment / totalTime * 100) : 0
                
                return {
                    totalDrive,
                    totalTreatment,
                    totalTime,
                    efficiency: efficiency.toFixed(1),
                    count: optimizedRoute.length,
                    exceedsMax: totalDrive > 180
                }
            }
        }

        const routeOptimizer = new RouteOptimizer()
        // ========== END ROUTE OPTIMIZER ==========

        let currentWeekOffset = 0
        let optimizerWeekOffset = 0
        let allAppointments = []
        let allClients = []
        let allBlocked = []
        let allZones = []

        async function init() {
            await loadData()
            updateStats()
            showSchedule()
            populateClientDropdown()
            setupFormListeners()
        }

        async function loadData() {
            try {
                const { data: appointments } = await client
                    .from('appointments')
                    .select('*, clients(*)')
                    .order('appointment_date', { ascending: true })
                allAppointments = appointments || []

                const { data: clients } = await client
                    .from('clients')
                    .select('*')
                    .eq('is_active', true)
                    .order('client_name', { ascending: true})
                allClients = clients || []

                const { data: blocked } = await client
                    .from('blocked_periods')
                    .select('*')
                    .order('start_date', { ascending: true })
                allBlocked = blocked || []

            } catch (error) {
                console.error('Error loading data:', error)
            }
        }

        function populateClientDropdown() {
            const select = document.getElementById('aptClient')
            select.innerHTML = '<option value="">Select client...</option>'
            allClients.forEach(c => {
                select.innerHTML += `<option value="${c.id}">${c.client_name}</option>`
            })
        }

        function setupFormListeners() {
            // Auto-calculate pricing and total
            document.getElementById('aptClient').addEventListener('change', autoCalculatePrice)
            document.getElementById('aptService').addEventListener('change', autoCalculatePrice)
            document.getElementById('aptType').addEventListener('change', autoCalculatePrice)
            document.getElementById('aptNumAnimals').addEventListener('input', autoCalculatePrice)
            document.getElementById('aptPrice').addEventListener('input', calcTotal)
            document.getElementById('aptTravel').addEventListener('input', calcTotal)
            
            // Form submissions
            document.getElementById('clientForm').addEventListener('submit', saveClient)
            document.getElementById('appointmentForm').addEventListener('submit', saveAppointment)
            document.getElementById('blockForm').addEventListener('submit', saveBlock)
        }

        function autoCalculatePrice() {
            const clientId = document.getElementById('aptClient').value
            const serviceType = document.getElementById('aptService').value
            const aptType = document.getElementById('aptType').value
            const numAnimals = parseInt(document.getElementById('aptNumAnimals').value) || 1

            if (!clientId || !serviceType || !aptType) return

            // Find client to check legacy pricing
            const selectedClient = allClients.find(c => c.id === clientId)
            const isLegacy = selectedClient?.legacy_pricing || false

            // For 'both' service type, manual pricing
            if (serviceType === 'both') {
                document.getElementById('aptDuration').value = 105 // 60 + 45 default
                document.getElementById('aptPrice').value = isLegacy ? 165 : 210 // Equine + canine initial estimate
                
                if (selectedClient) {
                    const zone = findZoneByPostcode(selectedClient.postcode)
                    if (zone) {
                        document.getElementById('aptTravel').value = zone.travel_fee
                    }
                }
                calcTotal()
                return
            }

            // Calculate duration
            let duration = 60
            if (serviceType === 'equine') {
                duration = numAnimals === 1 ? 60 : numAnimals * 45
            } else {
                duration = numAnimals === 1 ? 45 : numAnimals * 30
            }
            document.getElementById('aptDuration').value = duration

            // Calculate price based on pricing rules
            let price = 0
            const isMultiple = numAnimals > 1

            if (isLegacy) {
                // Legacy pricing
                if (serviceType === 'equine') {
                    if (aptType === 'initial') {
                        price = 120
                    } else {
                        price = numAnimals * 100
                    }
                } else {
                    if (aptType === 'initial') {
                        price = 85
                    } else {
                        price = numAnimals * 65
                    }
                }
            } else {
                // New pricing
                if (serviceType === 'equine') {
                    if (aptType === 'initial') {
                        price = 130
                    } else {
                        price = numAnimals * 110
                    }
                } else {
                    if (aptType === 'initial') {
                        price = 100
                    } else {
                        price = numAnimals * 80
                    }
                }
            }

            document.getElementById('aptPrice').value = price
            
            // Auto-calculate travel fee based on client postcode
            if (selectedClient) {
                const zone = findZoneByPostcode(selectedClient.postcode)
                if (zone) {
                    document.getElementById('aptTravel').value = zone.travel_fee
                }
            }

            calcTotal()
        }

        function findZoneByPostcode(postcode) {
            return allZones.find(z => z.postcodes.includes(postcode))
        }

        function calcTotal() {
            const price = parseFloat(document.getElementById('aptPrice').value) || 0
            const travel = parseFloat(document.getElementById('aptTravel').value) || 0
            document.getElementById('aptTotal').value = (price + travel).toFixed(2)
        }

        function showAddClientModal() {
            document.getElementById('clientModal').classList.remove('hidden')
            document.getElementById('clientForm').reset()
            delete document.getElementById('clientForm').dataset.editId
        }

        function editClient(id) {
            const c = allClients.find(cl => cl.id === id)
            if (!c) return

            document.getElementById('clientName').value = c.client_name
            document.getElementById('clientAddress').value = c.address
            document.getElementById('clientPostcode').value = c.postcode
            document.getElementById('clientPhone').value = c.phone || ''
            document.getElementById('clientEmail').value = c.email || ''
            document.getElementById('clientFB').value = c.fb_contact || ''
            document.getElementById('clientProperty').value = c.property_name || ''
            document.getElementById('clientAccess').value = c.access_instructions || ''
            document.getElementById('clientNotes').value = c.notes || ''
            document.getElementById('clientLegacy').checked = c.legacy_pricing

            document.getElementById('clientForm').dataset.editId = id
            document.getElementById('clientModal').classList.remove('hidden')
        }

        function showAddAppointmentModal() {
            document.getElementById('appointmentModal').classList.remove('hidden')
            document.getElementById('appointmentForm').reset()
            delete document.getElementById('appointmentForm').dataset.editId
            calcTotal()
            // Trigger auto-calculation when client is selected
            setTimeout(() => {
                const clientSelect = document.getElementById('aptClient')
                if (clientSelect.value) {
                    autoCalculatePrice()
                }
            }, 100)
        }

        function showAddBlockModal() {
            document.getElementById('blockModal').classList.remove('hidden')
            document.getElementById('blockForm').reset()
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden')
        }

        async function saveClient(e) {
            e.preventDefault()
            
            try {
                const data = {
                    client_name: document.getElementById('clientName').value,
                    address: document.getElementById('clientAddress').value,
                    postcode: document.getElementById('clientPostcode').value,
                    phone: document.getElementById('clientPhone').value || null,
                    email: document.getElementById('clientEmail').value || null,
                    fb_contact: document.getElementById('clientFB').value || null,
                    property_name: document.getElementById('clientProperty').value || null,
                    access_instructions: document.getElementById('clientAccess').value || null,
                    notes: document.getElementById('clientNotes').value || null,
                    legacy_pricing: document.getElementById('clientLegacy').checked,
                    is_active: true
                }

                const editId = document.getElementById('clientForm').dataset.editId
                let error

                if (editId) {
                    const result = await client.from('clients').update(data).eq('id', editId)
                    error = result.error
                } else {
                    const result = await client.from('clients').insert([data])
                    error = result.error
                }
                
                if (error) throw error

                closeModal('clientModal')
                delete document.getElementById('clientForm').dataset.editId
                await loadData()
                updateStats()
                populateClientDropdown()
                showClients()
                alert(editId ? 'Client updated!' : 'Client added! You can now book appointments for them.')

            } catch (error) {
                console.error('Error saving client:', error)
                alert('Error saving client: ' + error.message)
            }
        }

        async function saveAppointment(e) {
            e.preventDefault()
            
            try {
                const data = {
                    client_id: document.getElementById('aptClient').value,
                    appointment_date: document.getElementById('aptDate').value,
                    appointment_time: document.getElementById('aptTime').value,
                    service_type: document.getElementById('aptService').value,
                    appointment_type: document.getElementById('aptType').value,
                    number_of_animals: parseInt(document.getElementById('aptNumAnimals').value),
                    duration_minutes: parseInt(document.getElementById('aptDuration').value),
                    status: document.getElementById('aptStatus').value,
                    treatment_price: parseFloat(document.getElementById('aptPrice').value),
                    travel_fee: parseFloat(document.getElementById('aptTravel').value),
                    total_price: parseFloat(document.getElementById('aptTotal').value),
                    notes: document.getElementById('aptNotes').value || null
                }

                const editId = document.getElementById('appointmentForm').dataset.editId
                let error

                if (editId) {
                    // Update existing
                    const result = await client.from('appointments').update(data).eq('id', editId)
                    error = result.error
                } else {
                    // Insert new
                    const result = await client.from('appointments').insert([data])
                    error = result.error
                }
                
                if (error) throw error

                closeModal('appointmentModal')
                delete document.getElementById('appointmentForm').dataset.editId
                await loadData()
                updateStats()
                showSchedule()
                alert(editId ? 'Appointment updated!' : 'Appointment added!')

            } catch (error) {
                console.error('Error saving appointment:', error)
                alert('Error saving appointment: ' + error.message)
            }
        }

        async function saveBlock(e) {
            e.preventDefault()
            
            try {
                const data = {
                    start_date: document.getElementById('blockStartDate').value,
                    end_date: document.getElementById('blockEndDate').value,
                    start_time: document.getElementById('blockStartTime').value || null,
                    end_time: document.getElementById('blockEndTime').value || null,
                    reason: document.getElementById('blockReason').value
                }

                const { error } = await client.from('blocked_periods').insert([data])
                
                if (error) throw error

                closeModal('blockModal')
                await loadData()
                showBlocked()
                alert('Block added successfully!')

            } catch (error) {
                console.error('Error saving block:', error)
                alert('Error saving block: ' + error.message)
            }
        }

        async function editAppointment(id) {
            const apt = allAppointments.find(a => a.id === id)
            if (!apt) return

            // Populate form with existing data
            document.getElementById('aptClient').value = apt.client_id
            document.getElementById('aptDate').value = apt.appointment_date
            document.getElementById('aptTime').value = apt.appointment_time
            document.getElementById('aptService').value = apt.service_type
            document.getElementById('aptType').value = apt.appointment_type
            document.getElementById('aptNumAnimals').value = apt.number_of_animals
            document.getElementById('aptDuration').value = apt.duration_minutes
            document.getElementById('aptStatus').value = apt.status
            document.getElementById('aptPrice').value = apt.treatment_price
            document.getElementById('aptTravel').value = apt.travel_fee
            document.getElementById('aptNotes').value = apt.notes || ''
            calcTotal()

            // Store ID for update
            document.getElementById('appointmentForm').dataset.editId = id
            document.getElementById('appointmentModal').classList.remove('hidden')
        }

        async function deleteAppointment(id) {
            if (!confirm('Delete this appointment?')) return
            
            try {
                const { error } = await client.from('appointments').delete().eq('id', id)
                if (error) throw error
                
                await loadData()
                updateStats()
                showSchedule()
                alert('Appointment deleted!')
            } catch (error) {
                console.error('Error deleting appointment:', error)
                alert('Error: ' + error.message)
            }
        }

        async function deleteBlock(id) {
            if (!confirm('Delete this blocked period?')) return
            
            try {
                const { error } = await client.from('blocked_periods').delete().eq('id', id)
                if (error) throw error
                
                await loadData()
                showBlocked()
                alert('Block deleted!')
            } catch (error) {
                console.error('Error deleting block:', error)
                alert('Error: ' + error.message)
            }
        }

        function updateStats() {
            const now = new Date()
            const startOfWeek = new Date(now)
            startOfWeek.setDate(now.getDate() - now.getDay() + 1)
            const endOfWeek = new Date(startOfWeek)
            endOfWeek.setDate(startOfWeek.getDate() + 6)

            const in8Weeks = new Date(now)
            in8Weeks.setDate(now.getDate() + 56)

            const thisWeek = allAppointments.filter(apt => {
                const date = new Date(apt.appointment_date)
                return date >= startOfWeek && date <= endOfWeek && apt.status === 'confirmed'
            })

            const next8Weeks = allAppointments.filter(apt => {
                const date = new Date(apt.appointment_date)
                return date >= now && date <= in8Weeks && apt.status === 'confirmed'
            })

            const ytdRevenue = allAppointments
                .filter(apt => apt.status === 'confirmed' && new Date(apt.appointment_date).getFullYear() === now.getFullYear())
                .reduce((sum, apt) => sum + parseFloat(apt.total_price || 0), 0)

            const pendingCount = allAppointments.filter(apt => apt.status === 'pending').length

            document.getElementById('statsThisWeek').textContent = thisWeek.length
            document.getElementById('statsNext8Weeks').textContent = next8Weeks.length
            document.getElementById('statsRevenue').textContent = '$' + ytdRevenue.toFixed(0)
            document.getElementById('statsClients').textContent = allClients.length
            document.getElementById('pendingBadge').textContent = pendingCount
        }

        function showTab(tab) {
            document.getElementById('contentSchedule').classList.add('hidden')
            document.getElementById('contentOptimizer').classList.add('hidden')
            document.getElementById('contentPending').classList.add('hidden')
            document.getElementById('contentBlocked').classList.add('hidden')
            document.getElementById('contentClients').classList.add('hidden')
            document.getElementById('contentRevenue').classList.add('hidden')

            document.getElementById('tabSchedule').className = 'px-6 py-3 font-semibold text-gray-600 hover:text-gray-900 whitespace-nowrap'
            document.getElementById('tabOptimizer').className = 'px-6 py-3 font-semibold text-gray-600 hover:text-gray-900 whitespace-nowrap'
            document.getElementById('tabPending').className = 'px-6 py-3 font-semibold text-gray-600 hover:text-gray-900 whitespace-nowrap'
            document.getElementById('tabBlocked').className = 'px-6 py-3 font-semibold text-gray-600 hover:text-gray-900 whitespace-nowrap'
            document.getElementById('tabClients').className = 'px-6 py-3 font-semibold text-gray-600 hover:text-gray-900 whitespace-nowrap'
            document.getElementById('tabRevenue').className = 'px-6 py-3 font-semibold text-gray-600 hover:text-gray-900 whitespace-nowrap'

            if (tab === 'schedule') {
                document.getElementById('contentSchedule').classList.remove('hidden')
                document.getElementById('tabSchedule').className = 'px-6 py-3 font-semibold border-b-2 border-blue-600 text-blue-600 whitespace-nowrap'
                showSchedule()
            } else if (tab === 'optimizer') {
                document.getElementById('contentOptimizer').classList.remove('hidden')
                document.getElementById('tabOptimizer').className = 'px-6 py-3 font-semibold border-b-2 border-blue-600 text-blue-600 whitespace-nowrap'
                showOptimizer()
            } else if (tab === 'pending') {
                document.getElementById('contentPending').classList.remove('hidden')
                document.getElementById('tabPending').className = 'px-6 py-3 font-semibold border-b-2 border-blue-600 text-blue-600 whitespace-nowrap'
                showPending()
            } else if (tab === 'blocked') {
                document.getElementById('contentBlocked').classList.remove('hidden')
                document.getElementById('tabBlocked').className = 'px-6 py-3 font-semibold border-b-2 border-blue-600 text-blue-600 whitespace-nowrap'
                showBlocked()
            } else if (tab === 'clients') {
                document.getElementById('contentClients').classList.remove('hidden')
                document.getElementById('tabClients').className = 'px-6 py-3 font-semibold border-b-2 border-blue-600 text-blue-600 whitespace-nowrap'
                showClients()
            } else if (tab === 'revenue') {
                document.getElementById('contentRevenue').classList.remove('hidden')
                document.getElementById('tabRevenue').className = 'px-6 py-3 font-semibold border-b-2 border-blue-600 text-blue-600 whitespace-nowrap'
                showRevenue()
            }
        }

        function changeWeek(offset) {
            if (offset === 0) {
                currentWeekOffset = 0
            } else {
                currentWeekOffset += offset
            }
            showSchedule()
        }

        function showPending() {
            const pending = allAppointments.filter(apt => apt.status === 'pending')

            let html = '<div class="space-y-4">'
            
            if (pending.length === 0) {
                html += '<p class="text-center text-gray-500 py-8">No pending requests</p>'
            } else {
                pending.forEach(apt => {
                    html += `
                        <div class="border-2 border-yellow-300 rounded-lg p-4 bg-yellow-50">
                            <div class="flex flex-col lg:flex-row justify-between gap-4">
                                <div class="flex-1">
                                    <div class="text-xl font-bold text-yellow-900">NEW BOOKING REQUEST</div>
                                    <div class="text-2xl font-bold text-blue-600 mt-2">${new Date(apt.appointment_date).toLocaleDateString('en-AU', {weekday: 'long', month: 'long', day: 'numeric'})} at ${apt.appointment_time}</div>
                                    <div class="text-lg font-semibold mt-3">${apt.clients?.client_name || 'Unknown'}</div>
                                    <div class="text-sm text-gray-600">${apt.clients?.address || ''}, ${apt.clients?.postcode || ''}</div>
                                    ${apt.clients?.phone ? `<div class="text-sm font-semibold mt-2">üì± ${apt.clients.phone}</div>` : ''}
                                    ${apt.clients?.email ? `<div class="text-sm text-gray-600">üìß ${apt.clients.email}</div>` : ''}
                                    ${apt.clients?.fb_contact ? `<div class="text-sm text-gray-600">üí¨ ${apt.clients.fb_contact}</div>` : ''}
                                    ${apt.clients?.property_name ? `<div class="text-sm text-gray-600 mt-1">üè° ${apt.clients.property_name}</div>` : ''}
                                    ${apt.clients?.access_instructions ? `<div class="text-sm text-gray-600 mt-1">üöó ${apt.clients.access_instructions}</div>` : ''}
                                    <div class="text-sm mt-2">
                                        <span class="font-semibold">${apt.service_type === 'equine' ? 'üê¥' : 'üêï'} ${apt.number_of_animals} ${apt.service_type}</span>
                                        ${apt.appointment_type === 'initial' ? ' ‚Ä¢ Initial' : ' ‚Ä¢ Follow-up'}
                                        ‚Ä¢ ${apt.duration_minutes} min
                                    </div>
                                    ${apt.clients?.notes ? `<div class="text-sm text-gray-600 mt-2">üìù ${apt.clients.notes}</div>` : ''}
                                    ${apt.notes ? `<div class="text-sm text-gray-600 mt-1">üí¨ ${apt.notes}</div>` : ''}
                                </div>
                                <div class="text-right lg:text-left">
                                    <div class="text-lg font-bold">$${apt.total_price}</div>
                                    <div class="text-xs text-gray-600">($${apt.treatment_price} + $${apt.travel_fee} travel)</div>
                                    <div class="space-y-2 mt-4">
                                        <button onclick="approveBooking('${apt.id}')" class="block w-full px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 font-semibold">
                                            ‚úì Confirm Booking
                                        </button>
                                        <button onclick="editAppointment('${apt.id}')" class="block w-full px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                            Edit Details
                                        </button>
                                        <button onclick="declineBooking('${apt.id}')" class="block w-full px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                                            ‚úó Decline
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `
                })
            }
            html += '</div>'

            document.getElementById('pendingView').innerHTML = html
        }

        async function approveBooking(id) {
            if (!confirm('Confirm this booking?')) return
            
            try {
                const { error } = await client
                    .from('appointments')
                    .update({ status: 'confirmed', confirmed_at: new Date().toISOString() })
                    .eq('id', id)

                if (error) throw error

                await loadData()
                updateStats()
                showPending()
                alert('Booking confirmed! Client will be notified.')

            } catch (error) {
                console.error('Error approving booking:', error)
                alert('Error: ' + error.message)
            }
        }

        async function declineBooking(id) {
            const reason = prompt('Reason for declining (optional):')
            if (reason === null) return // Cancelled
            
            try {
                const { error } = await client
                    .from('appointments')
                    .update({ 
                        status: 'cancelled', 
                        cancelled_at: new Date().toISOString(),
                        cancellation_reason: reason || 'Declined by admin'
                    })
                    .eq('id', id)

                if (error) throw error

                await loadData()
                updateStats()
                showPending()
                alert('Booking declined.')

            } catch (error) {
                console.error('Error declining booking:', error)
                alert('Error: ' + error.message)
            }
        }

        function showSchedule() {
            const now = new Date()
            const startOfWeek = new Date(now)
            startOfWeek.setDate(now.getDate() - now.getDay() + 1 + (currentWeekOffset * 7))
            const endOfWeek = new Date(startOfWeek)
            endOfWeek.setDate(startOfWeek.getDate() + 6)

            const weekAppointments = allAppointments.filter(apt => {
                const date = new Date(apt.appointment_date)
                return date >= startOfWeek && date <= endOfWeek
            }).sort((a, b) => {
                if (a.appointment_date === b.appointment_date) {
                    return a.appointment_time.localeCompare(b.appointment_time)
                }
                return a.appointment_date.localeCompare(b.appointment_date)
            })

            let html = `<div class="mb-4 text-center text-xl font-semibold">
                Week of ${startOfWeek.toLocaleDateString('en-AU', {month: 'long', day: 'numeric', year: 'numeric'})}
            </div>`

            if (weekAppointments.length === 0) {
                html += '<p class="text-center text-gray-500 py-8">No appointments this week</p>'
            } else {
                let currentDate = null
                weekAppointments.forEach(apt => {
                    if (apt.appointment_date !== currentDate) {
                        if (currentDate !== null) html += '</div>'
                        currentDate = apt.appointment_date
                        const date = new Date(apt.appointment_date)
                        html += `<div class="mb-6">
                            <h3 class="text-lg font-bold mb-3 pb-2 border-b">
                                ${date.toLocaleDateString('en-AU', {weekday: 'long', month: 'long', day: 'numeric'})}
                            </h3>`
                    }

                    const statusColors = {
                        confirmed: 'bg-green-100 border-green-300',
                        pending: 'bg-yellow-100 border-yellow-300',
                        cancelled: 'bg-red-100 border-red-300',
                        completed: 'bg-gray-100 border-gray-300'
                    }

                    html += `
                        <div class="mb-3 p-4 border-2 rounded-lg ${statusColors[apt.status] || 'bg-white border-gray-200'}">
                            <div class="flex flex-col sm:flex-row justify-between gap-4">
                                <div class="flex-1">
                                    <div class="text-xl font-bold">${apt.appointment_time}</div>
                                    <div class="text-lg font-semibold">${apt.clients?.client_name || 'Unknown Client'}</div>
                                    <div class="text-sm text-gray-600">${apt.clients?.address || ''}, ${apt.clients?.postcode || ''}</div>
                                    <div class="text-sm mt-1">
                                        <span class="font-semibold">${apt.service_type === 'equine' ? 'üê¥' : 'üêï'} ${apt.number_of_animals} ${apt.service_type}</span>
                                        ${apt.appointment_type === 'initial' ? ' ‚Ä¢ Initial' : ' ‚Ä¢ Follow-up'}
                                    </div>
                                    ${apt.notes ? `<div class="text-sm text-gray-600 mt-1">üìù ${apt.notes}</div>` : ''}
                                </div>
                                <div class="text-right">
                                    <div class="text-lg font-bold">$${apt.total_price}</div>
                                    <div class="text-xs text-gray-600">${apt.duration_minutes} min</div>
                                    <div class="text-xs px-2 py-1 rounded mt-2 inline-block ${statusColors[apt.status] || ''}">${apt.status.toUpperCase()}</div>
                                    <div class="mt-2 flex gap-1 justify-end">
                                        <button onclick="editAppointment('${apt.id}')" class="px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700">Edit</button>
                                        <button onclick="deleteAppointment('${apt.id}')" class="px-2 py-1 bg-red-600 text-white text-xs rounded hover:bg-red-700">Delete</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `
                })
                if (currentDate !== null) html += '</div>'
            }

            document.getElementById('scheduleView').innerHTML = html
        }

        function showBlocked() {
            let html = '<div class="space-y-3">'
            
            if (allBlocked.length === 0) {
                html += '<p class="text-center text-gray-500 py-8">No blocked periods</p>'
            } else {
                allBlocked.forEach(block => {
                    const start = new Date(block.start_date)
                    const end = new Date(block.end_date)
                    html += `
                        <div class="border-2 border-red-300 rounded-lg p-4 bg-red-50">
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="text-lg font-bold">${start.toLocaleDateString('en-AU')} - ${end.toLocaleDateString('en-AU')}</div>
                                    ${block.start_time ? `<div class="text-sm text-gray-600">${block.start_time} - ${block.end_time}</div>` : '<div class="text-sm text-gray-600">All day</div>'}
                                    <div class="text-sm mt-1 font-semibold">${block.reason}</div>
                                </div>
                                <button onclick="deleteBlock('${block.id}')" class="px-3 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700">
                                    Delete
                                </button>
                            </div>
                        </div>
                    `
                })
            }
            html += '</div>'
            document.getElementById('blockedView').innerHTML = html
        }

        function showClients() {
            let html = '<div class="space-y-3">'
            allClients.forEach(client => {
                html += `
                    <div class="border rounded-lg p-4 hover:shadow-lg transition-shadow">
                        <div class="flex flex-col sm:flex-row justify-between gap-4">
                            <div class="flex-1">
                                <div class="text-lg font-bold">${client.client_name}</div>
                                <div class="text-sm text-gray-600">${client.address}, ${client.postcode}</div>
                                ${client.phone ? `<div class="text-sm text-gray-600">üì± ${client.phone}</div>` : ''}
                                ${client.email ? `<div class="text-sm text-gray-600">üìß ${client.email}</div>` : ''}
                                ${client.fb_contact ? `<div class="text-sm text-gray-600">üí¨ ${client.fb_contact}</div>` : ''}
                                ${client.notes ? `<div class="text-sm text-gray-500 mt-1">üìù ${client.notes}</div>` : ''}
                            </div>
                            <div class="text-right">
                                ${client.legacy_pricing ? '<div class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded inline-block mb-2">Legacy Pricing</div>' : ''}
                                <div>
                                    <button onclick="editClient('${client.id}')" class="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">Edit</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `
            })
            html += '</div>'
            document.getElementById('clientsView').innerHTML = html
        }

        function showRevenue() {
            const now = new Date()
            const thisYear = now.getFullYear()
            
            const months = {}
            for (let i = 0; i < 12; i++) {
                months[i] = { month: new Date(thisYear, i, 1).toLocaleDateString('en-AU', {month: 'long'}), revenue: 0, count: 0 }
            }

            allAppointments
                .filter(apt => apt.status === 'confirmed' && new Date(apt.appointment_date).getFullYear() === thisYear)
                .forEach(apt => {
                    const month = new Date(apt.appointment_date).getMonth()
                    months[month].revenue += parseFloat(apt.total_price || 0)
                    months[month].count++
                })

            let html = `
                <div class="mb-6">
                    <h3 class="text-xl font-bold mb-4">${thisYear} Revenue by Month</h3>
                    <div class="space-y-2">
            `

            Object.values(months).forEach(m => {
                if (m.count > 0) {
                    html += `
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
                            <div>
                                <span class="font-semibold">${m.month}</span>
                                <span class="text-sm text-gray-600 ml-2">(${m.count} appointments)</span>
                            </div>
                            <div class="text-lg font-bold text-green-600">$${m.revenue.toFixed(2)}</div>
                        </div>
                    `
                }
            })

            const totalRevenue = Object.values(months).reduce((sum, m) => sum + m.revenue, 0)
            const totalAppts = Object.values(months).reduce((sum, m) => sum + m.count, 0)

            html += `
                    </div>
                </div>
                <div class="bg-blue-50 p-6 rounded-lg">
                    <h3 class="text-xl font-bold mb-2">Year-to-Date Totals</h3>
                    <div class="text-3xl font-bold text-blue-600">$${totalRevenue.toFixed(2)}</div>
                    <div class="text-gray-600">${totalAppts} confirmed appointments</div>
                    <div class="text-gray-600 mt-2">Average: $${(totalRevenue / totalAppts).toFixed(2)} per appointment</div>
                </div>
            `

            document.getElementById('revenueView').innerHTML = html
        }

        // ========== ROUTE OPTIMIZER DISPLAY ==========
        function optimizerChangeWeek(offset) {
            optimizerWeekOffset += offset
            showOptimizer()
        }

        function showOptimizer() {
            const now = new Date()
            const monday = new Date(now)
            monday.setDate(now.getDate() - now.getDay() + 1 + (optimizerWeekOffset * 7))
            const sunday = new Date(monday)
            sunday.setDate(monday.getDate() + 6)

            const startDate = monday.toISOString().split('T')[0]
            const endDate = sunday.toISOString().split('T')[0]

            // Get confirmed appointments for this week
            const weekApts = allAppointments.filter(apt => 
                apt.appointment_date >= startDate && 
                apt.appointment_date <= endDate &&
                apt.status === 'confirmed'
            )

            // Group by date
            const byDate = {}
            weekApts.forEach(apt => {
                if (!byDate[apt.appointment_date]) {
                    byDate[apt.appointment_date] = []
                }
                byDate[apt.appointment_date].push({
                    ...apt,
                    postcode: apt.clients?.postcode || '6082',
                    duration_minutes: apt.duration_minutes
                })
            })

            // Build HTML
            let html = `<div class="space-y-6">`

            if (Object.keys(byDate).length === 0) {
                html += `<p class="text-center text-gray-500 py-8">No confirmed appointments this week</p>`
            } else {
                Object.keys(byDate).sort().forEach(date => {
                    const appointments = byDate[date]
                    const optimized = routeOptimizer.optimizeSequence(appointments)
                    const metrics = routeOptimizer.calculateMetrics(optimized)

                    const dateObj = new Date(date)
                    const dayName = dateObj.toLocaleDateString('en-AU', {weekday: 'long', month: 'long', day: 'numeric'})

                    // Color code by drive time
                    let driveColor = 'green'
                    if (metrics.totalDrive > 180) driveColor = 'red'
                    else if (metrics.totalDrive > 120) driveColor = 'yellow'

                    html += `
                        <div class="border-2 ${driveColor === 'red' ? 'border-red-400' : driveColor === 'yellow' ? 'border-yellow-400' : 'border-green-400'} rounded-lg p-6 bg-white">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <h3 class="text-xl font-bold">${dayName}</h3>
                                    <div class="text-sm text-gray-600 mt-1">${metrics.count} appointment${metrics.count > 1 ? 's' : ''}</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-3xl font-bold text-${driveColor === 'red' ? 'red' : driveColor === 'yellow' ? 'yellow' : 'green'}-600">
                                        ${metrics.totalDrive} min
                                    </div>
                                    <div class="text-xs text-gray-600">total driving</div>
                                    <div class="text-sm font-semibold mt-1">${metrics.efficiency}% efficiency</div>
                                </div>
                            </div>

                            <div class="space-y-3">
                                <div class="flex items-center text-sm">
                                    <div class="w-3 h-3 bg-blue-500 rounded-full mr-2"></div>
                                    <span class="font-semibold">HOME</span>
                                    <span class="text-gray-400 mx-2">‚Üí</span>
                                    <span class="text-gray-600">${optimized[0]?.driveFromHome || 0} min drive</span>
                                </div>
                    `

                    optimized.forEach((apt, index) => {
                        const loc = routeOptimizer.locations[apt.postcode]
                        html += `
                            <div class="bg-gray-50 rounded p-3">
                                <div class="flex justify-between items-start">
                                    <div class="flex-1">
                                        <div class="font-bold text-lg">#${apt.sequence} - ${apt.appointment_time}</div>
                                        <div class="text-sm font-semibold">${apt.clients?.client_name}</div>
                                        <div class="text-sm text-gray-600">${loc?.name || apt.postcode}</div>
                                        <div class="text-xs text-gray-500 mt-1">${apt.duration_minutes} min treatment</div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-sm font-bold text-${apt.service_type === 'equine' ? 'blue' : 'green'}-600">
                                            ${apt.service_type === 'equine' ? 'üê¥' : 'üêï'} ${apt.number_of_animals}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `

                        if (index < optimized.length - 1) {
                            html += `
                                <div class="flex items-center text-sm ml-4">
                                    <span class="text-gray-400 mr-2">‚Üì</span>
                                    <span class="text-gray-600">${optimized[index + 1].driveFromPrevious} min drive</span>
                                </div>
                            `
                        }
                    })

                    html += `
                                <div class="flex items-center text-sm">
                                    <span class="text-gray-400 mr-2">‚Üì</span>
                                    <span class="text-gray-600">${optimized[optimized.length - 1]?.driveToHome || 0} min drive</span>
                                </div>
                                <div class="flex items-center text-sm">
                                    <div class="w-3 h-3 bg-blue-500 rounded-full mr-2"></div>
                                    <span class="font-semibold">HOME</span>
                                </div>
                            </div>

                            <div class="mt-4 pt-4 border-t grid grid-cols-3 gap-4 text-center text-sm">
                                <div>
                                    <div class="font-bold text-lg">${metrics.totalTreatment} min</div>
                                    <div class="text-gray-600">Treatment</div>
                                </div>
                                <div>
                                    <div class="font-bold text-lg">${metrics.totalDrive} min</div>
                                    <div class="text-gray-600">Driving</div>
                                </div>
                                <div>
                                    <div class="font-bold text-lg">${metrics.totalTime} min</div>
                                    <div class="text-gray-600">Total</div>
                                </div>
                            </div>

                            ${metrics.exceedsMax ? `
                                <div class="mt-3 p-3 bg-red-50 border border-red-300 rounded">
                                    <div class="text-red-800 text-sm font-semibold">‚ö†Ô∏è Warning: Exceeds 3-hour drive limit</div>
                                </div>
                            ` : ''}
                        </div>
                    `
                })
            }

            html += `</div>`
            document.getElementById('optimizerView').innerHTML = html
        }
        // ========== END ROUTE OPTIMIZER DISPLAY ==========

        init()
    </script>
</body>
</html>
