<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Booking - Equine & Canine Massage WA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gradient-to-br from-green-50 to-blue-50">
    <div class="min-h-screen p-4">
        <div class="max-w-3xl mx-auto pt-8">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <div class="text-center mb-8">
                    <h1 class="text-4xl font-bold text-gray-800 mb-2">Book Your Appointment</h1>
                    <p class="text-gray-600">Smart scheduling with geographic optimization</p>
                </div>

                <div id="step1" class="space-y-6">
                    <h2 class="text-2xl font-bold mb-4">Step 1: Tell Us About Your Location</h2>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Which service do you need? *
                        </label>
                        <select id="serviceType" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">Please select...</option>
                            <option value="equine">üê¥ Equine Massage</option>
                            <option value="canine">üêï Canine Massage</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Your Postcode *
                        </label>
                        <input type="text" id="postcode" placeholder="e.g., 6171" required 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <p class="text-xs text-gray-500 mt-1">We'll check if we service your area</p>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Number of Animals
                        </label>
                        <input type="number" id="numberOfAnimals" value="1" min="1" max="15" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Appointment Type *
                        </label>
                        <select id="appointmentType" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="initial">Initial Assessment</option>
                            <option value="follow-up">Follow-up Session</option>
                        </select>
                    </div>

                    <button onclick="checkAvailability()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                        Check Availability ‚Üí
                    </button>
                </div>

                <div id="step2" class="hidden">
                    <div id="availabilityResults"></div>
                </div>

                <div id="step3" class="hidden">
                    <h2 class="text-2xl font-bold mb-4">Step 3: Your Details</h2>
                    <form id="bookingForm" class="space-y-4">
                        <!-- Client details form will be inserted here -->
                    </form>
                </div>

                <div id="confirmation" class="hidden text-center py-12">
                    <div class="text-6xl mb-4">‚úÖ</div>
                    <h2 class="text-3xl font-bold text-green-700 mb-4">Booking Request Sent!</h2>
                    <p class="text-gray-700">We'll confirm your appointment within 24 hours.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Supabase
        const SUPABASE_URL = 'https://lnlwsluopuprtqooorgi.supabase.co'
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxubHdzbHVvcHVwcnRxb29vcmdpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3NTkyOTIsImV4cCI6MjA3ODMzNTI5Mn0.k9R1TAjIn74sznur24mocLFKQYLWYILAQL8tM0hs5dg'
        const { createClient } = supabase
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY)

        let selectedZone = null
        let availableSlots = []

        async function checkAvailability() {
            const postcode = document.getElementById('postcode').value
            const serviceType = document.getElementById('serviceType').value
            const numberOfAnimals = parseInt(document.getElementById('numberOfAnimals').value)
            const appointmentType = document.getElementById('appointmentType').value

            if (!postcode || !serviceType) {
                alert('Please fill in all required fields')
                return
            }

            // Show loading
            document.getElementById('step1').innerHTML = '<div class="text-center py-12"><div class="text-4xl mb-4">üîç</div><p class="text-xl">Checking availability...</p></div>'

            try {
                // 1. Find zone for postcode
                const { data: zones, error: zoneError } = await supabaseClient
                    .from('geographic_zones')
                    .select('*')
                    .contains('postcodes', [postcode])

                if (zoneError || !zones || zones.length === 0) {
                    showError('Sorry, this postcode is outside our service area. Please contact us directly.')
                    return
                }

                selectedZone = zones[0]

                // 2. Get appointments for next 8 weeks
                const startDate = new Date().toISOString().split('T')[0]
                const endDate = new Date(Date.now() + 56 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]

                const { data: appointments } = await supabaseClient
                    .from('appointments')
                    .select(`
                        *,
                        clients (
                            postcode
                        )
                    `)
                    .gte('appointment_date', startDate)
                    .lte('appointment_date', endDate)
                    .eq('status', 'confirmed')

                // 3. Get blocked periods
                const { data: blockedPeriods } = await supabaseClient
                    .from('blocked_periods')
                    .select('*')
                    .gte('end_date', startDate)

                // 4. Calculate available slots
                availableSlots = calculateSlots(selectedZone, appointments || [], blockedPeriods || [], serviceType, numberOfAnimals, appointmentType, startDate, endDate)

                // 5. Show results
                showAvailability(availableSlots, selectedZone)

            } catch (error) {
                console.error('Error:', error)
                showError('Something went wrong. Please try again or contact us directly.')
            }
        }

        function calculateSlots(zone, appointments, blockedPeriods, serviceType, numberOfAnimals, appointmentType, startDate, endDate) {
            const slots = []
            const duration = serviceType === 'equine' ? (numberOfAnimals === 1 ? 60 : numberOfAnimals * 45) : (numberOfAnimals === 1 ? 45 : numberOfAnimals * 30)
            
            const workingHours = {
                0: null, // Sunday
                1: { start: '05:00', end: '18:00' }, // Monday
                2: { start: '05:00', end: '18:00' }, // Tuesday
                3: { start: '08:00', end: '18:00' }, // Wednesday
                4: { start: '05:00', end: '18:00' }, // Thursday
                5: { start: '09:00', end: '18:00' }, // Friday
                6: null // Saturday
            }

            let currentDate = new Date(startDate)
            const endDateObj = new Date(endDate)

            while (currentDate <= endDateObj && slots.length < 20) {
                const dateStr = currentDate.toISOString().split('T')[0]
                const dayOfWeek = currentDate.getDay()
                const dayName = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'][dayOfWeek]

                // Check if working day
                const hours = workingHours[dayOfWeek]
                if (!hours) {
                    currentDate.setDate(currentDate.getDate() + 1)
                    continue
                }

                // Check if blocked
                const isBlocked = blockedPeriods.some(block => {
                    const blockStart = new Date(block.start_date)
                    const blockEnd = new Date(block.end_date)
                    return currentDate >= blockStart && currentDate <= blockEnd
                })

                if (isBlocked) {
                    currentDate.setDate(currentDate.getDate() + 1)
                    continue
                }

                // CRITICAL RULE: If there are ANY appointments on this day,
                // ONLY show slots in zones that already have appointments
                // This prevents cross-zone driving and routing conflicts
                const dayAppts = appointments.filter(a => a.appointment_date === dateStr)
                
                if (dayAppts.length > 0) {
                    // Check which zones already have appointments on this day
                    const zonesWithAppts = new Set()
                    dayAppts.forEach(apt => {
                        if (apt.clients?.postcode) {
                            // Find which zone this appointment is in
                            if (zone.postcodes.includes(apt.clients.postcode)) {
                                zonesWithAppts.add(zone.zone_name)
                            }
                        }
                    })
                    
                    // If this zone doesn't have appointments on this day, skip it
                    if (!zonesWithAppts.has(zone.zone_name)) {
                        currentDate.setDate(currentDate.getDate() + 1)
                        continue
                    }
                }

                // Check if preferred day or has existing appointments in zone
                const isPreferred = zone.preferred_days.includes(dayName)
                const hasZoneAppts = appointments.some(apt => 
                    apt.appointment_date === dateStr && 
                    zone.postcodes.includes(apt.clients?.postcode)
                )

                if (isPreferred || hasZoneAppts) {
                    // Generate time slots
                    const timeSlots = generateTimeSlots(dateStr, hours, dayAppts, duration, zone, hasZoneAppts)
                    slots.push(...timeSlots)
                }

                currentDate.setDate(currentDate.getDate() + 1)
            }

            return slots.sort((a, b) => b.score - a.score).slice(0, 10)
        }

        function generateTimeSlots(date, hours, dayAppts, duration, zone, hasZoneAppts) {
            const slots = []
            const startMins = timeToMins(hours.start)
            const endMins = timeToMins(hours.end)

            for (let mins = startMins; mins + duration + 15 <= endMins; mins += 60) {
                const timeStr = minsToTime(mins)
                
                // Check conflicts
                const hasConflict = dayAppts.some(apt => {
                    const aptStart = timeToMins(apt.appointment_time)
                    const aptEnd = aptStart + apt.duration_minutes + 15
                    return (mins < aptEnd && mins + duration + 15 > aptStart)
                })

                if (!hasConflict) {
                    const score = hasZoneAppts ? 80 : 50
                    slots.push({
                        date,
                        time: timeStr,
                        duration,
                        zone: zone.zone_name,
                        travelFee: zone.travel_fee,
                        driveTime: zone.drive_time_minutes,
                        score,
                        reason: hasZoneAppts ? '‚≠ê Perfect! Clusters with other appointments in your area' : '‚úì Available time slot'
                    })
                }
            }

            return slots
        }

        function timeToMins(time) {
            const [h, m] = time.split(':').map(Number)
            return h * 60 + m
        }

        function minsToTime(mins) {
            const h = Math.floor(mins / 60)
            const m = mins % 60
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`
        }

        function showAvailability(slots, zone) {
            const resultsDiv = document.getElementById('availabilityResults')
            
            if (slots.length === 0) {
                resultsDiv.innerHTML = `
                    <div class="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-6">
                        <h3 class="text-xl font-bold text-yellow-900 mb-2">No Available Times</h3>
                        <p class="text-yellow-800">We don't have availability in ${zone.zone_name} in the next 8 weeks. Please contact us directly to discuss options.</p>
                    </div>
                `
            } else {
                const slotHTML = slots.map((slot, index) => `
                    <div class="bg-white border-2 ${slot.score >= 80 ? 'border-green-300' : 'border-gray-200'} rounded-lg p-4 hover:shadow-lg transition-shadow cursor-pointer" onclick="selectSlot(${index})">
                        <div class="flex justify-between items-center">
                            <div>
                                <div class="text-lg font-bold">${new Date(slot.date).toLocaleDateString('en-AU', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'})}</div>
                                <div class="text-2xl font-bold text-blue-600">${slot.time}</div>
                                <div class="text-sm text-gray-600 mt-1">${slot.reason}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-sm text-gray-600">Drive time</div>
                                <div class="font-semibold">${slot.driveTime} min</div>
                                <div class="text-sm text-gray-600 mt-2">Travel fee</div>
                                <div class="font-semibold">$${slot.travelFee}</div>
                            </div>
                        </div>
                    </div>
                `).join('')

                resultsDiv.innerHTML = `
                    <div class="mb-6">
                        <button onclick="goBack()" class="text-blue-600 hover:text-blue-800">‚Üê Back</button>
                        <h2 class="text-2xl font-bold mt-4 mb-2">Available Times in ${zone.zone_name}</h2>
                        <p class="text-gray-600 mb-4">Select your preferred time slot:</p>
                    </div>
                    <div class="space-y-3">
                        ${slotHTML}
                    </div>
                `
            }

            document.getElementById('step1').classList.add('hidden')
            document.getElementById('step2').classList.remove('hidden')
        }

        let selectedSlot = null
        let bookingData = {}

        function selectSlot(index) {
            selectedSlot = availableSlots[index]
            bookingData.serviceType = document.getElementById('serviceType').value
            bookingData.numberOfAnimals = document.getElementById('numberOfAnimals').value
            bookingData.appointmentType = document.getElementById('appointmentType').value
            bookingData.postcode = document.getElementById('postcode').value
            
            showClientDetailsForm()
        }

        function showClientDetailsForm() {
            const formHTML = `
                <div class="mb-6">
                    <button onclick="goBackToSlots()" class="text-blue-600 hover:text-blue-800">‚Üê Back to time slots</button>
                    <h2 class="text-2xl font-bold mt-4 mb-2">Almost Done! Your Details</h2>
                    <div class="bg-blue-50 p-4 rounded-lg mb-4">
                        <p class="font-semibold">Selected Time:</p>
                        <p class="text-lg">${new Date(selectedSlot.date).toLocaleDateString('en-AU', {weekday: 'long', month: 'long', day: 'numeric'})} at ${selectedSlot.time}</p>
                        <p class="text-sm text-gray-600 mt-2">Estimated cost: $${calculateEstimatedPrice()} (treatment) + $${selectedSlot.travelFee} (travel) = $${calculateEstimatedPrice() + selectedSlot.travelFee}</p>
                    </div>
                </div>

                <form id="clientDetailsForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Your Name *</label>
                        <input type="text" id="clientName" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Full Address *</label>
                        <input type="text" id="clientAddress" required placeholder="e.g., 123 Main Street, Suburb" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Phone *</label>
                            <input type="tel" id="clientPhone" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Email</label>
                            <input type="email" id="clientEmail" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Facebook Name</label>
                            <input type="text" id="clientFB" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Property Name (if applicable)</label>
                        <input type="text" id="clientProperty" placeholder="e.g., Sunny Acres Farm" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Access Instructions</label>
                        <textarea id="clientAccess" rows="2" placeholder="e.g., Gate code, where to park, how to find you" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Animal Names & Any Special Notes</label>
                        <textarea id="clientNotes" rows="2" placeholder="e.g., Max (gelding, 15yo), Luna (needs gentle approach)" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></textarea>
                    </div>

                    <div class="bg-gray-50 p-4 rounded-lg">
                        <p class="text-sm text-gray-700 mb-2">
                            <strong>Please note:</strong> This is a booking request. Bernadette will confirm your appointment within 24 hours.
                        </p>
                    </div>

                    <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition-colors">
                        Submit Booking Request ‚Üí
                    </button>
                </form>
            `

            document.getElementById('step2').innerHTML = formHTML
            document.getElementById('clientDetailsForm').addEventListener('submit', submitBooking)
        }

        function calculateEstimatedPrice() {
            const numAnimals = parseInt(bookingData.numberOfAnimals)
            const isInitial = bookingData.appointmentType === 'initial'
            const isEquine = bookingData.serviceType === 'equine'

            // Use NEW pricing for all online bookings
            if (isEquine) {
                return isInitial ? 130 : numAnimals * 110
            } else {
                return isInitial ? 100 : numAnimals * 80
            }
        }

        async function submitBooking(e) {
            e.preventDefault()

            const submitBtn = e.target.querySelector('button[type="submit"]')
            submitBtn.disabled = true
            submitBtn.textContent = 'Submitting...'

            try {
                // First, create the client
                const clientData = {
                    client_name: document.getElementById('clientName').value,
                    address: document.getElementById('clientAddress').value,
                    postcode: bookingData.postcode,
                    phone: document.getElementById('clientPhone').value,
                    email: document.getElementById('clientEmail').value || null,
                    fb_contact: document.getElementById('clientFB').value || null,
                    property_name: document.getElementById('clientProperty').value || null,
                    access_instructions: document.getElementById('clientAccess').value || null,
                    notes: document.getElementById('clientNotes').value || null,
                    legacy_pricing: false,
                    is_active: true
                }

                const { data: newClient, error: clientError } = await client
                    .from('clients')
                    .insert([clientData])
                    .select()

                if (clientError) throw clientError

                // Then create the appointment
                const duration = bookingData.serviceType === 'equine' 
                    ? (parseInt(bookingData.numberOfAnimals) === 1 ? 60 : parseInt(bookingData.numberOfAnimals) * 45)
                    : (parseInt(bookingData.numberOfAnimals) === 1 ? 45 : parseInt(bookingData.numberOfAnimals) * 30)

                const treatmentPrice = calculateEstimatedPrice()

                const appointmentData = {
                    client_id: newClient[0].id,
                    appointment_date: selectedSlot.date,
                    appointment_time: selectedSlot.time,
                    service_type: bookingData.serviceType,
                    appointment_type: bookingData.appointmentType,
                    number_of_animals: parseInt(bookingData.numberOfAnimals),
                    duration_minutes: duration,
                    status: 'pending',
                    treatment_price: treatmentPrice,
                    travel_fee: selectedSlot.travelFee,
                    total_price: treatmentPrice + selectedSlot.travelFee,
                    notes: `Online booking from ${selectedSlot.zone}`
                }

                const { error: appointmentError } = await client
                    .from('appointments')
                    .insert([appointmentData])

                if (appointmentError) throw appointmentError

                // Show confirmation
                showConfirmation()

            } catch (error) {
                console.error('Error submitting booking:', error)
                alert('Sorry, there was an error submitting your booking. Please try again or contact us directly.')
                submitBtn.disabled = false
                submitBtn.textContent = 'Submit Booking Request ‚Üí'
            }
        }

        function showConfirmation() {
            document.getElementById('step2').innerHTML = `
                <div class="text-center py-12">
                    <div class="text-6xl mb-4">‚úÖ</div>
                    <h2 class="text-3xl font-bold text-green-700 mb-4">Booking Request Sent!</h2>
                    <div class="bg-green-50 border-2 border-green-300 rounded-lg p-6 mb-6">
                        <p class="text-lg font-semibold mb-2">Your requested appointment:</p>
                        <p class="text-2xl font-bold">${new Date(selectedSlot.date).toLocaleDateString('en-AU', {weekday: 'long', month: 'long', day: 'numeric'})}</p>
                        <p class="text-2xl font-bold text-blue-600">${selectedSlot.time}</p>
                    </div>
                    <p class="text-gray-700 mb-2">Bernadette will confirm your appointment within 24 hours.</p>
                    <p class="text-gray-600 text-sm">You'll be contacted via ${document.getElementById('clientPhone').value}</p>
                    <button onclick="location.reload()" class="mt-6 px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        Book Another Appointment
                    </button>
                </div>
            `
        }

        function goBackToSlots() {
            showAvailability(availableSlots, selectedZone)
        }

        function goBack() {
            location.reload()
        }

        function showError(message) {
            document.getElementById('step1').innerHTML = `
                <div class="bg-red-50 border-2 border-red-300 rounded-lg p-6">
                    <h3 class="text-xl font-bold text-red-900 mb-2">Unable to Book Online</h3>
                    <p class="text-red-800 mb-4">${message}</p>
                    <button onclick="location.reload()" class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700">
                        Try Again
                    </button>
                </div>
            `
        }
    </script>
</body>
</html>
