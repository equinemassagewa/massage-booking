<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Appointment - Equine & Canine Massage WA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gradient-to-br from-green-50 to-blue-50">
    <div class="min-h-screen p-4">
        <div class="max-w-3xl mx-auto pt-8">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <div class="text-center mb-8">
                    <h1 class="text-4xl font-bold text-gray-800 mb-2">Book Your Appointment</h1>
                    <p class="text-gray-600">Choose a 3-hour window - we'll confirm exact time 24 hours before</p>
                </div>

                <div id="step1" class="space-y-6">
                    <h2 class="text-2xl font-bold mb-4">Step 1: Service Details</h2>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Which service do you need? *
                        </label>
                        <select id="serviceType" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">Please select...</option>
                            <option value="equine">üê¥ Equine Massage</option>
                            <option value="canine">üêï Canine Massage</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Your Postcode *
                        </label>
                        <input type="text" id="postcode" placeholder="e.g., 6171" required 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <p class="text-xs text-gray-500 mt-1">We'll check if we service your area</p>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Number of Animals
                        </label>
                        <input type="number" id="numberOfAnimals" value="1" min="1" max="15" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Appointment Type *
                        </label>
                        <select id="appointmentType" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="initial">Initial Assessment</option>
                            <option value="follow-up">Follow-up Session</option>
                        </select>
                    </div>

                    <button onclick="checkAvailability()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                        Check Availability ‚Üí
                    </button>
                </div>

                <div id="step2" class="hidden">
                    <div id="availabilityResults"></div>
                </div>

                <div id="step3" class="hidden">
                    <div id="clientDetailsForm"></div>
                </div>

                <div id="confirmation" class="hidden text-center py-12">
                    <div class="text-6xl mb-4">‚úÖ</div>
                    <h2 class="text-3xl font-bold text-green-700 mb-4">Booking Request Sent!</h2>
                    <div class="bg-green-50 border-2 border-green-300 rounded-lg p-6 mb-6">
                        <p class="text-lg font-semibold mb-2">We'll confirm your exact appointment time 24 hours before</p>
                        <p class="text-gray-700">You'll receive a message with your specific time</p>
                    </div>
                    <button onclick="location.reload()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        Book Another Appointment
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://lnlwsluopuprtqooorgi.supabase.co'
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxubHdzbHVvcHVwcnRxb29vcmdpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3NTkyOTIsImV4cCI6MjA3ODMzNTI5Mn0.k9R1TAjIn74sznur24mocLFKQYLWYILAQL8tM0hs5dg'
        
        const { createClient } = supabase
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY)

        let selectedZone = null
        let selectedSlot = null
        let availableSlots = []
        let bookingData = {}

        // TIME WINDOWS (3-hour blocks)
        const TIME_WINDOWS = [
            { id: 'morning', label: 'Morning (8am-11am)', start: '08:00', end: '11:00' },
            { id: 'midday', label: 'Midday (11am-2pm)', start: '11:00', end: '14:00' },
            { id: 'afternoon', label: 'Afternoon (2pm-5pm)', start: '14:00', end: '17:00' }
        ]

        async function checkAvailability() {
            const postcode = document.getElementById('postcode').value
            const serviceType = document.getElementById('serviceType').value
            const numberOfAnimals = parseInt(document.getElementById('numberOfAnimals').value)
            const appointmentType = document.getElementById('appointmentType').value

            if (!postcode || !serviceType) {
                alert('Please fill in all required fields')
                return
            }

            // Store booking data NOW before step1 gets replaced
            bookingData = {
                postcode: postcode,
                serviceType: serviceType,
                numberOfAnimals: numberOfAnimals,
                appointmentType: appointmentType
            }

            document.getElementById('step1').innerHTML = '<div class="text-center py-12"><div class="text-4xl mb-4">üîç</div><p class="text-xl">Checking availability...</p></div>'

            try {
                // Load all zones
                const { data: allZones } = await supabaseClient.from('geographic_zones').select('*')
                const zone = allZones.find(z => z.postcodes.includes(postcode))

                if (!zone) {
                    showError('Sorry, this postcode is outside our service area. Please contact us directly.')
                    return
                }

                selectedZone = zone

                // Get appointments for next 8 weeks
                const startDate = new Date().toISOString().split('T')[0]
                const endDate = new Date(Date.now() + 56 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]

                const { data: appointments } = await supabaseClient
                    .from('appointments')
                    .select('*, clients(postcode)')
                    .gte('appointment_date', startDate)
                    .lte('appointment_date', endDate)
                    .in('status', ['confirmed', 'pending'])

                const { data: blockedPeriods } = await supabaseClient
                    .from('blocked_periods')
                    .select('*')
                    .gte('end_date', startDate)

                // Calculate available slots
                availableSlots = calculateWindowSlots(zone, allZones, appointments || [], blockedPeriods || [], startDate, endDate)

                showAvailability()

            } catch (error) {
                console.error('Error:', error)
                showError('Something went wrong. Please try again or contact us directly.')
            }
        }

        function calculateWindowSlots(zone, allZones, appointments, blockedPeriods, startDate, endDate) {
            const slots = []
            const workingDays = {
                2: true, // Tuesday
                3: true, // Wednesday  
                4: true, // Thursday
                5: true  // Friday
            }

            const now = new Date()
            const todayStr = now.toISOString().split('T')[0]
            
            let currentDate = new Date(startDate)
            const endDateObj = new Date(endDate)

            while (currentDate <= endDateObj && slots.length < 30) {
                const dateStr = currentDate.toISOString().split('T')[0]
                const dayOfWeek = currentDate.getDay()
                const dayName = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'][dayOfWeek]

                // Skip if not working day
                if (!workingDays[dayOfWeek]) {
                    currentDate.setDate(currentDate.getDate() + 1)
                    continue
                }

                // Skip if in past
                if (dateStr < todayStr) {
                    currentDate.setDate(currentDate.getDate() + 1)
                    continue
                }

                // Check if blocked
                const isBlocked = blockedPeriods.some(block => {
                    const blockStart = new Date(block.start_date)
                    const blockEnd = new Date(block.end_date)
                    return currentDate >= blockStart && currentDate <= blockEnd
                })

                if (isBlocked) {
                    currentDate.setDate(currentDate.getDate() + 1)
                    continue
                }

                // Check if day has appointments (same-zone rule)
                const dayAppts = appointments.filter(a => a.appointment_date === dateStr)
                
                if (dayAppts.length > 0) {
                    const zonesUsedToday = new Set()
                    dayAppts.forEach(apt => {
                        if (apt.clients?.postcode) {
                            const aptZone = allZones.find(z => z.postcodes.includes(apt.clients.postcode))
                            if (aptZone) zonesUsedToday.add(aptZone.zone_name)
                        }
                    })
                    
                    if (!zonesUsedToday.has(zone.zone_name)) {
                        currentDate.setDate(currentDate.getDate() + 1)
                        continue
                    }
                }

                // Check if preferred day or has zone appointments
                const isPreferred = zone.preferred_days.includes(dayName)
                const hasZoneAppts = dayAppts.some(apt => zone.postcodes.includes(apt.clients?.postcode))

                if (isPreferred || hasZoneAppts || dayAppts.length === 0) {
                    // For each time window, check if it's available
                    TIME_WINDOWS.forEach(window => {
                        const hasConflict = dayAppts.some(apt => {
                            if (!apt.time_window) return false
                            return apt.time_window === window.id
                        })

                        if (!hasConflict) {
                            slots.push({
                                date: dateStr,
                                window: window.id,
                                windowLabel: window.label,
                                zone: zone.zone_name,
                                travelFee: zone.travel_fee
                            })
                        }
                    })
                }

                currentDate.setDate(currentDate.getDate() + 1)
            }

            return slots
        }

        function showAvailability() {
            const resultsDiv = document.getElementById('availabilityResults')

            if (availableSlots.length === 0) {
                resultsDiv.innerHTML = `
                    <div class="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-6">
                        <h3 class="text-xl font-bold text-yellow-900 mb-2">No Available Times</h3>
                        <p class="text-yellow-800">We don't have availability in ${selectedZone.zone_name} in the next 8 weeks. Please contact us directly.</p>
                    </div>
                `
            } else {
                // Group by date
                const byDate = {}
                availableSlots.forEach(slot => {
                    if (!byDate[slot.date]) byDate[slot.date] = []
                    byDate[slot.date].push(slot)
                })

                let html = `
                    <div class="mb-6">
                        <button onclick="goBack()" class="text-blue-600 hover:text-blue-800">‚Üê Back</button>
                        <h2 class="text-2xl font-bold mt-4 mb-2">Available in ${selectedZone.zone_name}</h2>
                        <p class="text-gray-600 mb-4">Select a date and time window (we'll confirm exact time 24 hours before):</p>
                    </div>
                    <div class="space-y-6">
                `

                Object.keys(byDate).sort().slice(0, 10).forEach(date => {
                    const dateObj = new Date(date)
                    const dayLabel = dateObj.toLocaleDateString('en-AU', {weekday: 'long', month: 'long', day: 'numeric'})
                    
                    html += `
                        <div class="border-2 border-gray-200 rounded-lg p-4">
                            <h3 class="text-lg font-bold mb-3">${dayLabel}</h3>
                            <div class="grid grid-cols-1 gap-2">
                    `

                    byDate[date].forEach((slot, index) => {
                        const slotIndex = availableSlots.indexOf(slot)
                        html += `
                            <button onclick="selectSlot(${slotIndex})" class="bg-blue-50 hover:bg-blue-100 border-2 border-blue-300 rounded-lg p-4 text-left transition-colors">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <div class="text-xl font-bold text-blue-700">${slot.windowLabel}</div>
                                        <div class="text-sm text-gray-600 mt-1">Exact time confirmed 24hrs before</div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-sm text-gray-600">Travel fee</div>
                                        <div class="font-semibold">$${slot.travelFee}</div>
                                    </div>
                                </div>
                            </button>
                        `
                    })

                    html += `
                            </div>
                        </div>
                    `
                })

                html += `</div>`
                resultsDiv.innerHTML = html
            }

            document.getElementById('step1').classList.add('hidden')
            document.getElementById('step2').classList.remove('hidden')
        }

        function selectSlot(index) {
            selectedSlot = availableSlots[index]
            showClientDetailsForm()
        }

        function showClientDetailsForm() {
            const estimatedPrice = calculateEstimatedPrice()
            
            const formHTML = `
                <div class="mb-6">
                    <button onclick="goBackToSlots()" class="text-blue-600 hover:text-blue-800">‚Üê Back to time slots</button>
                    <h2 class="text-2xl font-bold mt-4 mb-2">Almost Done! Your Details</h2>
                    <div class="bg-blue-50 p-4 rounded-lg mb-4">
                        <p class="font-semibold">Selected Time Window:</p>
                        <p class="text-lg">${new Date(selectedSlot.date).toLocaleDateString('en-AU', {weekday: 'long', month: 'long', day: 'numeric'})}</p>
                        <p class="text-xl font-bold text-blue-700">${selectedSlot.windowLabel}</p>
                        <p class="text-sm text-gray-600 mt-2">Exact time will be confirmed 24 hours before your appointment</p>
                        <p class="text-sm text-gray-600 mt-2">Estimated cost: $${estimatedPrice} (treatment) + $${selectedSlot.travelFee} (travel) = $${estimatedPrice + selectedSlot.travelFee}</p>
                    </div>
                </div>

                <form id="submitForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Your Name *</label>
                        <input type="text" id="clientName" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Full Address *</label>
                        <input type="text" id="clientAddress" required placeholder="e.g., 123 Main Street, Suburb" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Phone *</label>
                            <input type="tel" id="clientPhone" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Email</label>
                            <input type="email" id="clientEmail" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Facebook Name</label>
                            <input type="text" id="clientFB" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Property Name (if applicable)</label>
                        <input type="text" id="clientProperty" placeholder="e.g., Sunny Acres Farm" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Access Instructions</label>
                        <textarea id="clientAccess" rows="2" placeholder="e.g., Gate code, where to park" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Animal Names & Notes</label>
                        <textarea id="clientNotes" rows="2" placeholder="e.g., Max (gelding, 15yo)" class="w-full px-4 py-2 border border-gray-300 rounded-lg"></textarea>
                    </div>

                    <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition-colors">
                        Submit Booking Request ‚Üí
                    </button>
                </form>
            `

            document.getElementById('clientDetailsForm').innerHTML = formHTML
            document.getElementById('step2').classList.add('hidden')
            document.getElementById('step3').classList.remove('hidden')
            document.getElementById('submitForm').addEventListener('submit', submitBooking)
        }

        function calculateEstimatedPrice() {
            const numAnimals = parseInt(bookingData.numberOfAnimals)
            const isInitial = bookingData.appointmentType === 'initial'
            const isEquine = bookingData.serviceType === 'equine'

            if (isEquine) {
                return isInitial ? 130 : numAnimals * 110
            } else {
                return isInitial ? 100 : numAnimals * 80
            }
        }

        async function submitBooking(e) {
            e.preventDefault()

            const submitBtn = e.target.querySelector('button[type="submit"]')
            submitBtn.disabled = true
            submitBtn.textContent = 'Submitting...'

            try {
                // Create client
                const clientData = {
                    client_name: document.getElementById('clientName').value,
                    address: document.getElementById('clientAddress').value,
                    postcode: bookingData.postcode,
                    phone: document.getElementById('clientPhone').value,
                    email: document.getElementById('clientEmail').value || null,
                    fb_contact: document.getElementById('clientFB').value || null,
                    property_name: document.getElementById('clientProperty').value || null,
                    access_instructions: document.getElementById('clientAccess').value || null,
                    notes: document.getElementById('clientNotes').value || null,
                    legacy_pricing: false,
                    is_active: true
                }

                const { data: newClient, error: clientError } = await supabaseClient
                    .from('clients')
                    .insert([clientData])
                    .select()

                if (clientError) throw clientError

                // Create appointment with time window
                const duration = bookingData.serviceType === 'equine' 
                    ? (parseInt(bookingData.numberOfAnimals) === 1 ? 60 : parseInt(bookingData.numberOfAnimals) * 45)
                    : (parseInt(bookingData.numberOfAnimals) === 1 ? 45 : parseInt(bookingData.numberOfAnimals) * 30)

                const treatmentPrice = calculateEstimatedPrice()

                const appointmentData = {
                    client_id: newClient[0].id,
                    appointment_date: selectedSlot.date,
                    time_window: selectedSlot.window, // WINDOW instead of exact time
                    appointment_time: null, // Will be set day before
                    service_type: bookingData.serviceType,
                    appointment_type: bookingData.appointmentType,
                    number_of_animals: parseInt(bookingData.numberOfAnimals),
                    duration_minutes: duration,
                    status: 'pending',
                    treatment_price: treatmentPrice,
                    travel_fee: selectedSlot.travelFee,
                    total_price: treatmentPrice + selectedSlot.travelFee,
                    notes: `Window booking: ${selectedSlot.windowLabel}`
                }

                const { error: appointmentError } = await supabaseClient
                    .from('appointments')
                    .insert([appointmentData])

                if (appointmentError) throw appointmentError

                showConfirmation()

            } catch (error) {
                console.error('Error:', error)
                alert('Error submitting booking. Please try again or contact us directly.')
                submitBtn.disabled = false
                submitBtn.textContent = 'Submit Booking Request ‚Üí'
            }
        }

        function showConfirmation() {
            document.getElementById('step3').classList.add('hidden')
            document.getElementById('confirmation').classList.remove('hidden')
        }

        function goBackToSlots() {
            document.getElementById('step3').classList.add('hidden')
            document.getElementById('step2').classList.remove('hidden')
        }

        function goBack() {
            location.reload()
        }

        function showError(message) {
            document.getElementById('step1').innerHTML = `
                <div class="bg-red-50 border-2 border-red-300 rounded-lg p-6">
                    <h3 class="text-xl font-bold text-red-900 mb-2">Unable to Book Online</h3>
                    <p class="text-red-800 mb-4">${message}</p>
                    <button onclick="location.reload()" class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700">
                        Try Again
                    </button>
                </div>
            `
        }
    </script>
</body>
</html>
