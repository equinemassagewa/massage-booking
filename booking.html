<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Booking - Equine & Canine Massage WA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2.39.3/dist/umd/supabase.js"></script>
</head>
<body class="bg-gradient-to-br from-green-50 to-blue-50">
    <div class="min-h-screen p-4">
        <div class="max-w-3xl mx-auto pt-8">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <div class="text-center mb-8">
                    <h1 class="text-4xl font-bold text-gray-800 mb-2">Book Your Appointment</h1>
                    <p class="text-gray-600">Smart scheduling with geographic optimization</p>
                </div>

                <div id="step1" class="space-y-6">
                    <h2 class="text-2xl font-bold mb-4">Tell Us About Your Location</h2>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Which service do you need? *
                        </label>
                        <select id="serviceType" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">Please select...</option>
                            <option value="equine">üê¥ Equine Massage</option>
                            <option value="canine">üêï Canine Massage</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Your Postcode *
                        </label>
                        <input type="text" id="postcode" placeholder="e.g., 6171" required 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <p class="text-xs text-gray-500 mt-1">We'll check if we service your area</p>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Number of Animals
                        </label>
                        <input type="number" id="numberOfAnimals" value="1" min="1" max="15" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Appointment Type *
                        </label>
                        <select id="appointmentType" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="initial">Initial Assessment</option>
                            <option value="follow-up">Follow-up Session</option>
                        </select>
                    </div>

                    <button onclick="checkAvailability()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                        Check Availability ‚Üí
                    </button>
                </div>

                <div id="step2" class="hidden">
                    <div id="availabilityResults"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://lnlwsluopuprtqooorgi.supabase.co'
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxubHdzbHVvcHVwcnRxb29vcmdpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3NTkyOTIsImV4cCI6MjA3ODMzNTI5Mn0.k9R1TAjIn74sznur24mocLFKQYLWYILAQL8tM0hs5dg'
        
        const { createClient } = supabase
        const client = createClient(SUPABASE_URL, SUPABASE_KEY)

        let selectedZone = null
        let availableSlots = []

        async function checkAvailability() {
            const postcode = document.getElementById('postcode').value
            const serviceType = document.getElementById('serviceType').value
            const numberOfAnimals = parseInt(document.getElementById('numberOfAnimals').value)

            if (!postcode || !serviceType) {
                alert('Please fill in all required fields')
                return
            }

            document.getElementById('step1').innerHTML = '<div class="text-center py-12"><div class="text-4xl mb-4">üîç</div><p class="text-xl">Checking availability...</p></div>'

            try {
                const { data: zones, error: zoneError } = await client
                    .from('geographic_zones')
                    .select('*')

                if (zoneError) throw zoneError

                const zone = zones.find(z => z.postcodes.includes(postcode))

                if (!zone) {
                    showError('Sorry, this postcode is outside our service area. Please contact us directly.')
                    return
                }

                selectedZone = zone

                const startDate = new Date().toISOString().split('T')[0]
                const endDate = new Date(Date.now() + 56 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]

                const { data: appointments } = await client
                    .from('appointments')
                    .select('*, clients(postcode)')
                    .gte('appointment_date', startDate)
                    .lte('appointment_date', endDate)
                    .eq('status', 'confirmed')

                const { data: blockedPeriods } = await client
                    .from('blocked_periods')
                    .select('*')
                    .gte('end_date', startDate)

                availableSlots = calculateSlots(selectedZone, appointments || [], blockedPeriods || [], serviceType, numberOfAnimals, startDate, endDate)
                showAvailability(availableSlots, selectedZone)

            } catch (error) {
                console.error('Error:', error)
                showError('Something went wrong: ' + error.message)
            }
        }

        function calculateSlots(zone, appointments, blockedPeriods, serviceType, numberOfAnimals, startDate, endDate) {
            const slots = []
            const duration = serviceType === 'equine' ? (numberOfAnimals === 1 ? 60 : numberOfAnimals * 45) : (numberOfAnimals === 1 ? 45 : numberOfAnimals * 30)
            
            const workingHours = {
                0: null,
                1: { start: '05:00', end: '18:00' },
                2: { start: '05:00', end: '18:00' },
                3: { start: '08:00', end: '18:00' },
                4: { start: '05:00', end: '18:00' },
                5: { start: '09:00', end: '18:00' },
                6: null
            }

            let currentDate = new Date(startDate)
            const endDateObj = new Date(endDate)

            while (currentDate <= endDateObj && slots.length < 20) {
                const dateStr = currentDate.toISOString().split('T')[0]
                const dayOfWeek = currentDate.getDay()
                const dayName = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'][dayOfWeek]
                const hours = workingHours[dayOfWeek]

                if (!hours) {
                    currentDate.setDate(currentDate.getDate() + 1)
                    continue
                }

                // Clone hours so we don't modify the original
                const adjustedHours = { ...hours }

                // Adjust Wednesday and Friday start times based on zone travel time
                // Can't leave home before 8am Wed, 9am Fri
                if (dayName === 'wednesday') {
                    if (zone.zone_name === 'Home Zone') {
                        adjustedHours.start = '08:30' // 8am + 20 min drive = 8:30 arrival
                    } else if (zone.zone_name === 'North Zone') {
                        adjustedHours.start = '09:00' // 8am + 35 min drive = 8:35, rounded to 9am
                    } else if (zone.zone_name === 'South Zone') {
                        adjustedHours.start = '09:00' // 8am + 50 min drive = 8:50, rounded to 9am
                    } else if (zone.zone_name === 'Far South Zone') {
                        adjustedHours.start = '09:30' // 8am + 75 min drive = 9:15, rounded to 9:30
                    }
                }

                if (dayName === 'friday') {
                    if (zone.zone_name === 'Home Zone') {
                        adjustedHours.start = '09:30' // 9am + 20 min drive = 9:20, rounded to 9:30
                    } else if (zone.zone_name === 'North Zone') {
                        adjustedHours.start = '10:00' // 9am + 35 min drive = 9:35, rounded to 10am
                    } else if (zone.zone_name === 'South Zone') {
                        adjustedHours.start = '10:00' // 9am + 50 min drive = 9:50, rounded to 10am
                    } else if (zone.zone_name === 'Far South Zone') {
                        adjustedHours.start = '10:30' // 9am + 75 min drive = 10:15, rounded to 10:30
                    }
                }

                const isBlocked = blockedPeriods.some(block => {
                    const blockStart = new Date(block.start_date)
                    const blockEnd = new Date(block.end_date)
                    return currentDate >= blockStart && currentDate <= blockEnd
                })

                if (isBlocked) {
                    currentDate.setDate(currentDate.getDate() + 1)
                    continue
                }

                const isPreferred = zone.preferred_days.includes(dayName)
                const hasZoneAppts = appointments.some(apt => 
                    apt.appointment_date === dateStr && 
                    zone.postcodes.includes(apt.clients?.postcode)
                )

                if (isPreferred || hasZoneAppts) {
                    const dayAppts = appointments.filter(a => a.appointment_date === dateStr)
                    const timeSlots = generateTimeSlots(dateStr, adjustedHours, dayAppts, duration, zone, hasZoneAppts)
                    slots.push(...timeSlots)
                }

                currentDate.setDate(currentDate.getDate() + 1)
            }

            return slots.sort((a, b) => b.score - a.score).slice(0, 10)
        }

        function generateTimeSlots(date, hours, dayAppts, duration, zone, hasZoneAppts) {
            const slots = []
            const startMins = timeToMins(hours.start)
            const endMins = timeToMins(hours.end)

            for (let mins = startMins; mins + duration + 15 <= endMins; mins += 60) {
                const timeStr = minsToTime(mins)
                const hasConflict = dayAppts.some(apt => {
                    const aptStart = timeToMins(apt.appointment_time)
                    const aptEnd = aptStart + apt.duration_minutes + 15
                    return (mins < aptEnd && mins + duration + 15 > aptStart)
                })

                if (!hasConflict) {
                    const score = hasZoneAppts ? 80 : 50
                    slots.push({
                        date,
                        time: timeStr,
                        duration,
                        zone: zone.zone_name,
                        travelFee: zone.travel_fee,
                        driveTime: zone.drive_time_minutes,
                        score,
                        reason: hasZoneAppts ? '‚≠ê Perfect! Clusters with other appointments' : '‚úì Available'
                    })
                }
            }
            return slots
        }

        function timeToMins(time) {
            const [h, m] = time.split(':').map(Number)
            return h * 60 + m
        }

        function minsToTime(mins) {
            const h = Math.floor(mins / 60)
            const m = mins % 60
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`
        }

        function showAvailability(slots, zone) {
            const resultsDiv = document.getElementById('availabilityResults')
            
            if (slots.length === 0) {
                resultsDiv.innerHTML = `
                    <div class="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-6">
                        <h3 class="text-xl font-bold text-yellow-900 mb-2">No Available Times</h3>
                        <p class="text-yellow-800">Contact us directly for scheduling.</p>
                    </div>
                `
            } else {
                const slotHTML = slots.map((slot, index) => `
                    <div class="bg-white border-2 ${slot.score >= 80 ? 'border-green-300' : 'border-gray-200'} rounded-lg p-4 hover:shadow-lg transition-shadow">
                        <div class="flex justify-between items-center">
                            <div>
                                <div class="text-lg font-bold">${new Date(slot.date).toLocaleDateString('en-AU', {weekday: 'long', month: 'long', day: 'numeric'})}</div>
                                <div class="text-2xl font-bold text-blue-600">${slot.time}</div>
                                <div class="text-sm text-gray-600 mt-1">${slot.reason}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-sm text-gray-600">Drive: ${slot.driveTime} min</div>
                                <div class="font-semibold">Fee: $${slot.travelFee}</div>
                            </div>
                        </div>
                    </div>
                `).join('')

                resultsDiv.innerHTML = `
                    <div class="mb-6">
                        <button onclick="location.reload()" class="text-blue-600 hover:text-blue-800">‚Üê Back</button>
                        <h2 class="text-2xl font-bold mt-4 mb-2">Available in ${zone.zone_name}</h2>
                        <p class="text-gray-600 mb-4">Contact us to book one of these times:</p>
                    </div>
                    <div class="space-y-3">
                        ${slotHTML}
                    </div>
                    <div class="mt-6 bg-blue-50 p-4 rounded-lg">
                        <p class="font-semibold">To complete your booking:</p>
                        <p class="text-sm">Contact us via Facebook Messenger with your preferred time from above.</p>
                    </div>
                `
            }

            document.getElementById('step1').classList.add('hidden')
            document.getElementById('step2').classList.remove('hidden')
        }

        function showError(message) {
            document.getElementById('step1').innerHTML = `
                <div class="bg-red-50 border-2 border-red-300 rounded-lg p-6">
                    <h3 class="text-xl font-bold text-red-900 mb-2">Unable to Check Availability</h3>
                    <p class="text-red-800 mb-4">${message}</p>
                    <button onclick="location.reload()" class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700">
                        Try Again
                    </button>
                </div>
            `
        }
    </script>
</body>
</html>
